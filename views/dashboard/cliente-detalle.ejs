<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/colors.css" rel="stylesheet">
    <link href="/css/dashboard.css" rel="stylesheet">

    <%- include('../partials/navbar-styles') %></head>
<body>
    <%- include('../partials/navbar-dashboard') %>
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0"><i class="fas fa-user me-2"></i>Cliente #<%= cliente.Id || cliente.id %></h3>
            <div class="d-flex align-items-center gap-2">
                <% 
                // Convertir "OK"/"KO" de la BD a estado para el switch
                const okValRaw = (cliente.OK_KO || cliente['OK/KO'] || 'KO').toString().toUpperCase().trim();
                const isActivo = (okValRaw === 'OK');
                %>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="toggleClienteEstado" 
                           <%= isActivo ? 'checked' : '' %> 
                           data-cliente-id="<%= cliente.Id || cliente.id %>"
                           style="width: 3rem; height: 1.5rem; cursor: pointer;">
                    <label class="form-check-label ms-2" for="toggleClienteEstado" style="cursor: pointer;">
                        <span id="estadoClienteText" class="fw-bold <%= isActivo ? 'text-success' : 'text-secondary' %>">
                            <%= isActivo ? 'Activo' : 'Inactivo' %>
                        </span>
                    </label>
                </div>
                <a href="/dashboard/clientes/<%= cliente.Id || cliente.id %>/contactos" class="btn btn-info">
                    <i class="fas fa-address-book me-1"></i>Contactos
                </a>
                <a href="/dashboard/clientes/<%= cliente.Id || cliente.id %>/mandato-sepa" class="btn btn-info"><i class="fas fa-file-invoice me-1"></i>Mandato SEPA</a>
                <a href="/dashboard/clientes/<%= cliente.Id || cliente.id %>/editar" class="btn btn-warning"><i class="fas fa-edit me-1"></i>Editar</a>
                <a href="/dashboard/clientes" class="btn btn-secondary"><i class="fas fa-arrow-left me-1"></i>Volver</a>
            </div>
        </div>
        <% if (error) { %>
        <div class="alert alert-danger"><%= error %></div>
        <% } %>
        <% if (typeof query !== 'undefined' && query.success === 'cliente_actualizado') { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>Cliente actualizado exitosamente.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <% } %>

        <div class="card">
            <div class="card-body">
                <div class="row g-3">
                    <% Object.keys(cliente).forEach(function(key){ %>
                        <div class="col-md-6">
                            <div class="border rounded p-2 h-100">
                                <div class="text-muted small"><%= key %></div>
                                <div class="fw-semibold"><%= (key === 'Pais' || key === 'pais') && typeof normalizeUTF8 !== 'undefined' ? normalizeUTF8(cliente[key] || '') : (cliente[key] || '') %></div>
                            </div>
                        </div>
                    <% }) %>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Toggle switch para activar/desactivar cliente
        document.addEventListener('DOMContentLoaded', function() {
            const toggleSwitch = document.getElementById('toggleClienteEstado');
            const estadoText = document.getElementById('estadoClienteText');
            
            if (toggleSwitch) {
                toggleSwitch.addEventListener('change', async function() {
                    const clienteId = this.getAttribute('data-cliente-id');
                    const nuevoEstado = this.checked; // true = Activo, false = Inactivo
                    const valorEnviar = nuevoEstado ? 'OK' : 'KO';
                    
                    // Deshabilitar switch durante la petici√≥n
                    this.disabled = true;
                    
                    try {
                        console.log('üîÑ [TOGGLE DETALLE] Cambiando estado:', { 
                            id: clienteId, 
                            nuevoEstado: nuevoEstado ? 'Activo' : 'Inactivo',
                            valorEnviar 
                        });
                        
                        const res = await fetch(`/api/clientes/${clienteId}/okko`, {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify({ value: valorEnviar })
                        });

                        if (!res.ok) {
                            const errorData = await res.json().catch(() => ({ error: `HTTP ${res.status}` }));
                            throw new Error(errorData.error || `Error HTTP ${res.status}`);
                        }

                        const data = await res.json();
                        
                        if (!data.success) {
                            throw new Error(data.error || 'Error al actualizar el estado');
                        }

                        console.log('‚úÖ [TOGGLE DETALLE] Estado actualizado correctamente');
                        
                        // Actualizar texto del estado
                        if (estadoText) {
                            estadoText.textContent = nuevoEstado ? 'Activo' : 'Inactivo';
                            estadoText.classList.remove('text-success', 'text-secondary');
                            estadoText.classList.add(nuevoEstado ? 'text-success' : 'text-secondary');
                        }
                        
                        // Mostrar mensaje de √©xito
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-success alert-dismissible fade show';
                        alertDiv.innerHTML = `
                            <i class="fas fa-check-circle me-2"></i>
                            Cliente ${nuevoEstado ? 'activado' : 'desactivado'} exitosamente.
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        const container = document.querySelector('.container');
                        if (container) {
                            container.insertBefore(alertDiv, container.firstChild);
                            // Auto-cerrar despu√©s de 3 segundos
                            setTimeout(() => {
                                alertDiv.classList.remove('show');
                                setTimeout(() => alertDiv.remove(), 150);
                            }, 3000);
                        }
                    } catch (err) {
                        console.error('‚ùå [TOGGLE DETALLE] Error completo:', err);
                        
                        // Revertir el switch
                        this.checked = !nuevoEstado;
                        
                        // Mostrar error
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                        alertDiv.innerHTML = `
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No se pudo actualizar el estado: ${err.message || 'Error desconocido'}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        const container = document.querySelector('.container');
                        if (container) {
                            container.insertBefore(alertDiv, container.firstChild);
                        }
                    } finally {
                        // Re-habilitar switch
                        this.disabled = false;
                    }
                });
            }
        });
    </script>
    <script src="/js/go-to-top.js"></script>

    <!-- Go to Top Button -->
    <button id="goToTop" class="go-to-top" title="Ir arriba">
        <i class="fas fa-arrow-up"></i>
    </button>
</body>
</html>







