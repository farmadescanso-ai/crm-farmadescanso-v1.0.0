<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/colors.css" rel="stylesheet">
    <link href="/css/dashboard.css" rel="stylesheet">
    <style>
        .table-container {
            max-height: 75vh;
            overflow: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.75rem;
        }
        .table-responsive {
            min-width: 100%;
        }
        .table th {
            position: sticky;
            top: 0;
            background-color: #fff;
            z-index: 10;
            border-bottom: 2px solid #dee2e6;
        }
        .table td {
            white-space: nowrap;
            padding: 0.75rem;
            font-size: 0.9rem;
            vertical-align: middle;
        }
        .search-box {
            background: #ffffff;
            padding: 1rem 1.5rem;
            border: 1px solid #dee2e6;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 5px 15px rgba(11, 137, 27, 0.05);
        }
        .articulo-row:hover {
            background-color: rgba(11, 137, 27, 0.05);
        }
        .highlight {
            background-color: #fff3cd;
            font-weight: 600;
        }
        .badge-pill {
            border-radius: 999px;
        }
    </style>
    <%- include('../partials/navbar-styles') %>
</head>
<body>
    <%- include('../partials/navbar-dashboard') %>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <div>
                        <h1 class="mb-0 text-primary"><i class="fas fa-boxes me-1 text-primary"></i>Artículos</h1>
                        <p class="text-muted mb-0">Visualiza el catálogo completo de productos</p>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-primary text-white fs-6 badge-pill">
                            Total registrados: <%= articulos.length %>
                        </span>
                        <% if (typeof esAdmin !== 'undefined' && esAdmin) { %>
                            <a href="/dashboard/articulos/nuevo" class="btn btn-success">
                                <i class="fas fa-plus me-1"></i>Nuevo Artículo
                            </a>
                        <% } %>
                    </div>
                </div>

                <% if (query && query.success === 'articulo_creado') { %>
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i>Artículo creado correctamente.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <% } %>
                <% if (query && query.success === 'articulo_eliminado') { %>
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i>Artículo eliminado correctamente.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <% } %>
                <% if (error || (query && query.error)) { %>
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <%= error || 'No se pudo completar la acción solicitada.' %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <% } %>

                <div class="search-box">
                    <div class="row g-3 align-items-center">
                        <div class="col-lg-3 col-md-4">
                            <label class="form-label fw-semibold text-muted">Buscar por</label>
                            <select class="form-select" id="searchField">
                                <option value="all">Todos los campos</option>
                                <option value="SKU">SKU</option>
                                <option value="Nombre">Nombre</option>
                                <option value="Marca">Marca</option>
                                <option value="Presentacion">Presentación</option>
                                <option value="EAN13">EAN 13</option>
                            </select>
                        </div>
                        <div class="col-lg-7 col-md-6">
                            <label class="form-label fw-semibold text-muted">Término</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="searchInput" placeholder="Escribe para filtrar artículos...">
                            </div>
                        </div>
                        <div class="col-lg-2 col-md-2">
                            <label class="form-label fw-semibold text-muted">&nbsp;</label>
                            <button class="btn btn-outline-secondary w-100" type="button" id="clearSearch">
                                <i class="fas fa-eraser me-1"></i>Limpiar
                            </button>
                        </div>
                    </div>
                    <div class="mt-3 text-muted small">
                        Mostrando <span id="articulosMostrados"><%= articulos.length %></span> de <%= articulos.length %> artículos
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table table-hover" id="articulosTable">
                            <thead class="table-light text-uppercase small">
                                <tr>
                                    <th>SKU</th>
                                    <th>Imagen</th>
                                    <th>Nombre</th>
                                    <th>Marca</th>
                                    <th>Presentación</th>
                                    <th class="text-end">PVL</th>
                                    <th class="text-center">Unidades / Caja</th>
                                    <th class="text-center">Estado</th>
                                    <th>Ean 13</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% articulos.forEach(function(articulo) { %>
                                <% const articuloJSON = JSON.stringify(articulo); %>
                                <tr class="articulo-row" data-articulo='<%- articuloJSON %>'>
                                    <td><%= articulo.SKU || '-' %></td>
                                    <td class="text-center">
                                        <% const thumb = articulo.Imagen || articulo.imagen; %>
                                        <% if (thumb) { %>
                                            <img src="<%= thumb %>" alt="Imagen artículo" class="rounded" style="width: 48px; height: 48px; object-fit: cover;" onerror="this.style.display='none'">
                                        <% } else { %>
                                            <i class="fas fa-image text-muted"></i>
                                        <% } %>
                                    </td>
                                    <td><%= articulo.Nombre || '-' %></td>
                                    <td><%= articulo.Marca || '-' %></td>
                                    <td><%= articulo['Presentación'] || articulo.Presentacion || '-' %></td>
                                    <td class="text-end">€ <%= formatearMonedaES(articulo.PVL || articulo.Pvl || articulo.pvl || 0, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                                    <td class="text-center"><%= articulo['Unidades / Caja'] || articulo['Unidades/Caja'] || articulo.Unidades_Caja || articulo.Unidades || '-' %></td>
                                    <% const estadoRaw = (articulo.OK_KO || articulo['OK/KO'] || articulo.Activo || 'Activo').toString().toLowerCase(); %>
                                    <% const articuloActivo = estadoRaw === 'activo' || articulo.Activo === 1 || articulo.Activo === true; %>
                                    <td class="text-center">
                                        <span class="badge <%= articuloActivo ? 'bg-success' : 'bg-secondary' %>">
                                            <%= articuloActivo ? 'Activo' : 'Inactivo' %>
                                        </span>
                                    </td>
                                    <td><%= articulo.EAN13 || articulo['EAN 13'] || articulo.EAN || '-' %></td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <a class="btn btn-sm btn-outline-primary" title="Ver" href="/dashboard/articulos/<%= articulo.Id || articulo.id %>">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <% if (typeof esAdmin !== 'undefined' && esAdmin) { %>
                                                <a class="btn btn-sm btn-outline-warning" title="Editar" href="/dashboard/articulos/<%= articulo.Id || articulo.id %>/editar">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <button type="button" class="btn btn-sm <%= articuloActivo ? 'btn-outline-success' : 'btn-outline-secondary' %> toggle-estado" data-id="<%= articulo.Id || articulo.id %>" data-activo="<%= articuloActivo %>" title="<%= articuloActivo ? 'Desactivar artículo' : 'Activar artículo' %>">
                                                    <i class="fas <%= articuloActivo ? 'fa-toggle-on' : 'fa-toggle-off' %>"></i>
                                                </button>
                                            <% } %>
                                        </div>
                                    </td>
                                </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const searchInput = document.getElementById('searchInput');
        const searchField = document.getElementById('searchField');
        const clearSearch = document.getElementById('clearSearch');
        const articulosMostrados = document.getElementById('articulosMostrados');
        const rows = Array.from(document.querySelectorAll('#articulosTable tbody tr'));

        function normalize(text) {
            if (!text) return '';
            return String(text)
                .toLowerCase()
                .normalize('NFD')
                .replace(/[^a-z0-9\s.-]/g, '')
                .trim();
        }

        function highlight(text, term) {
            if (!term || !text) return text;
            const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        function performSearch() {
            const field = searchField.value;
            const term = normalize(searchInput.value);
            let visible = 0;
            const highlightIndexMap = {
                'SKU': 0,
                'Nombre': 2,
                'Marca': 3,
                'Presentación': 4,
                'EAN 13': 8
            };
            const highlightIndexes = Object.values(highlightIndexMap);

            rows.forEach(row => {
                const data = JSON.parse(row.dataset.articulo || '{}');
                const cells = row.querySelectorAll('td');
                let match = false;

                if (!term) {
                    match = true;
                } else if (field === 'all') {
                    const values = [
                        data.SKU,
                        data.Nombre,
                        data.Marca,
                        data['Presentación'],
                        data.Presentacion,
                        data.EAN13,
                        data['EAN 13'],
                        data.EAN
                    ];
                    match = values.some(value => normalize(value).includes(term));
                } else {
                    let value;
                    switch (field) {
                        case 'SKU':
                            value = data.SKU;
                            break;
                        case 'Nombre':
                            value = data.Nombre;
                            break;
                        case 'Marca':
                            value = data.Marca;
                            break;
                        case 'Presentacion':
                            value = data['Presentación'] || data.Presentacion;
                            break;
                        case 'EAN13':
                            value = data.EAN13 || data['EAN 13'] || data.EAN;
                            break;
                        default:
                            value = '';
                    }
                    match = normalize(value).includes(term);
                }

                if (match) {
                    row.style.display = '';
                    visible++;

                    // resaltar coincidencias en columnas clave
                    if (term) {
                        ['SKU', 'Nombre', 'Marca', 'Presentación', 'EAN 13'].forEach((key) => {
                            const cell = cells[highlightIndexMap[key]];
                            if (cell) {
                                const originalText = cell.textContent;
                                cell.innerHTML = highlight(originalText, searchInput.value);
                            }
                        });
                    } else {
                        highlightIndexes.forEach(index => {
                            const cell = cells[index];
                            if (cell) {
                                cell.innerHTML = cell.textContent;
                            }
                        });
                    }
                } else {
                    row.style.display = 'none';
                }
            });

            articulosMostrados.textContent = visible;
        }

        searchInput.addEventListener('input', performSearch);
        searchField.addEventListener('change', performSearch);
        clearSearch.addEventListener('click', () => {
            searchInput.value = '';
            searchField.value = 'all';
            performSearch();
        });

        performSearch();

        // Solo admin puede cambiar el estado OK/KO
        const esAdmin = <%= (typeof esAdmin !== 'undefined' && esAdmin) ? 'true' : 'false' %>;
        if (!esAdmin) {
            // En la vista no se renderiza el botón, pero evitamos enganchar listeners por seguridad
            document.querySelectorAll('.toggle-estado').forEach(btn => btn.remove());
        }

        document.querySelectorAll('.toggle-estado').forEach(button => {
            button.addEventListener('click', async () => {
                if (button.dataset.loading === 'true') return;

                const row = button.closest('tr');
                const badge = row.querySelector('.badge');
                const id = button.getAttribute('data-id');
                const activo = button.getAttribute('data-activo') === 'true';
                const nuevoValor = activo ? 'Inactivo' : 'Activo';

                button.dataset.loading = 'true';
                button.disabled = true;

                try {
                    const response = await fetch(`/api/articulos/${id}/okko`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ value: nuevoValor })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: `HTTP ${response.status}` }));
                        throw new Error(errorData.error || `Error HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    if (!data.success) {
                        throw new Error(data.error || 'Error al actualizar el estado del artículo');
                    }

                    const ahoraActivo = !activo;
                    button.setAttribute('data-activo', String(ahoraActivo));
                    button.classList.remove('btn-outline-success', 'btn-outline-secondary');
                    button.classList.add(ahoraActivo ? 'btn-outline-success' : 'btn-outline-secondary');
                    button.title = ahoraActivo ? 'Desactivar artículo' : 'Activar artículo';

                    const icon = button.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-toggle-on', 'fa-toggle-off');
                        icon.classList.add(ahoraActivo ? 'fa-toggle-on' : 'fa-toggle-off');
                    }

                    if (badge) {
                        badge.classList.remove('bg-success', 'bg-secondary');
                        badge.classList.add(ahoraActivo ? 'bg-success' : 'bg-secondary');
                        badge.textContent = ahoraActivo ? 'Activo' : 'Inactivo';
                    }
                } catch (error) {
                    console.error('❌ [TOGGLE ARTÍCULO] Error:', error);
                    alert(`No se pudo actualizar el estado del artículo: ${error.message || 'Error desconocido'}`);
                } finally {
                    button.disabled = false;
                    button.dataset.loading = 'false';
                }
            });
        });
    </script>
    <script src="/js/go-to-top.js"></script>
    
    <!-- Go to Top Button -->
    <button id="goToTop" class="go-to-top" title="Ir arriba">
        <i class="fas fa-arrow-up"></i>
    </button>
</body>
</html>

