<%- include('index-crm', { 
  title: title, 
  user: user, 
  currentPage: currentPage, 
  error: typeof error !== 'undefined' ? error : null,
  estadisticas: typeof estadisticas !== 'undefined' ? estadisticas : { totalVentas: 0, ventasEsteMes: 0, totalEsteMes: 0, totalProductos: 0, totalComerciales: 0, totalClientes: 0, totalVisitas: 0 },
  ventas: typeof ventas !== 'undefined' ? ventas : [],
  productos: typeof productos !== 'undefined' ? productos : []
}) %>

<!-- DEBUG: Variables disponibles -->
<!-- debugPCP: <%= typeof debugPCP !== 'undefined' ? (debugPCP ? 'presente' : 'null') : 'no definido' %> -->

<div class="container-fluid mt-4" style="margin-left: 0; padding-left: 15px; padding-right: 15px;">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Rentabilidad por Pedido
                </h2>
                <div>
                    <a href="/dashboard/ajustes/rentabilidad-pedidos/comerciales" class="btn btn-info">
                        <i class="fas fa-users me-2"></i>Ver por Comercial
                    </a>
                </div>
            </div>

            <!-- Filtros -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="GET" action="/dashboard/ajustes/rentabilidad-pedidos" class="row g-3">
                        <div class="col-md-2">
                            <label for="comercial_id" class="form-label">Comercial</label>
                            <select class="form-select" id="comercial_id" name="comercial_id">
                                <option value="">Todos</option>
                                <% if (comerciales && Array.isArray(comerciales)) { %>
                                <% comerciales.forEach(comercial => { %>
                                <% const comercialId = comercial.Id || comercial.id; %>
                                <% const isComercialSelected = filtros.comercial_id == comercialId; %>
                                <option value="<%= comercialId %>"<% if (isComercialSelected) { %> selected<% } %>>
                                    <%= comercial.Nombre || comercial.nombre %>
                                </option>
                                <% }) %>
                                <% } %>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="marca_id" class="form-label">Marca</label>
                            <select class="form-select" id="marca_id" name="marca_id">
                                <option value="">Todas</option>
                                <% 
                                // Verificar y normalizar marcas
                                let marcasList = [];
                                
                                // Intentar obtener marcas de diferentes formas posibles
                                if (typeof marcas !== 'undefined' && marcas !== null) {
                                    if (Array.isArray(marcas)) {
                                        marcasList = marcas;
                                    } else if (typeof marcas === 'object') {
                                        // Si es un objeto único, convertirlo a array
                                        marcasList = [marcas];
                                    }
                                }
                                
                                // Si no hay marcas, usar valores hardcodeados temporalmente para debugging
                                if (marcasList.length === 0) {
                                    // Valores hardcodeados como fallback temporal
                                    marcasList = [
                                        { id: 1, Id: 1, Nombre: 'Youbelle', nombre: 'Youbelle' },
                                        { id: 2, Id: 2, Nombre: 'Gemavip', nombre: 'Gemavip' }
                                    ];
                                }
                                %>
                                <% if (marcasList && marcasList.length > 0) { %>
                                    <% marcasList.forEach((marca, index) => { %>
                                        <% 
                                        const marcaId = marca.id || marca.Id || null;
                                        // Obtener el valor del filtro de marca - manejar null, undefined, string vacío, etc.
                                        let filtroMarcaId = null;
                                        if (filtros && filtros.marca_id !== null && filtros.marca_id !== undefined && filtros.marca_id !== '') {
                                            filtroMarcaId = String(filtros.marca_id).trim();
                                        }
                                        const marcaIdStr = marcaId ? String(marcaId).trim() : null;
                                        // Comparar como strings - ambos deben ser no null y no vacíos
                                        const isSelected = filtroMarcaId !== null && marcaIdStr !== null && filtroMarcaId === marcaIdStr;
                                        const nombreMarca = marca.Nombre || marca.nombre || 'Sin nombre';
                                        %>
                                        <% if (marcaId) { %>
                                            <option value="<%= marcaId %>"<% if (isSelected) { %> selected<% } %>>
                                                <%= nombreMarca %>
                                            </option>
                                        <% } %>
                                    <% }) %>
                                <% } %>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="fecha_desde" class="form-label">Fecha Desde</label>
                            <input type="date" class="form-control" id="fecha_desde" name="fecha_desde" value="<%= filtros.fecha_desde || '' %>">
                        </div>
                        <div class="col-md-2">
                            <label for="fecha_hasta" class="form-label">Fecha Hasta</label>
                            <input type="date" class="form-control" id="fecha_hasta" name="fecha_hasta" value="<%= filtros.fecha_hasta || '' %>">
                        </div>
                        <div class="col-md-2">
                            <label for="tipo_pedido_id" class="form-label">Tipo de Pedido</label>
                            <select class="form-select" id="tipo_pedido_id" name="tipo_pedido_id">
                                <option value="">Todos</option>
                                <% 
                                // Verificar y normalizar tipos de pedido
                                let tiposPedidoList = [];
                                if (typeof tiposPedido !== 'undefined' && tiposPedido !== null) {
                                    if (Array.isArray(tiposPedido)) {
                                        tiposPedidoList = tiposPedido;
                                    } else if (typeof tiposPedido === 'object') {
                                        tiposPedidoList = [tiposPedido];
                                    }
                                }
                                %>
                                <% if (tiposPedidoList && tiposPedidoList.length > 0) { %>
                                <% tiposPedidoList.forEach(tipo => { %>
                                <% const tipoId = tipo.id || tipo.Id || null; %>
                                <% const isTipoSelected = filtros && filtros.tipo_pedido_id == tipoId; %>
                                <% const nombreTipo = tipo.Tipo || tipo.tipo || 'Sin nombre'; %>
                                <% if (tipoId) { %>
                                <option value="<%= tipoId %>"<% if (isTipoSelected) { %> selected<% } %>>
                                    <%= nombreTipo %>
                                </option>
                                <% } %>
                                <% }) %>
                                <% } %>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-filter me-2"></i>Filtrar
                            </button>
                            <a href="/dashboard/ajustes/rentabilidad-pedidos" class="btn btn-secondary">
                                <i class="fas fa-redo me-2"></i>Limpiar
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tabla de pedidos -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <colgroup>
                                <col style="width: 12%;">
                                <col style="width: 10%;">
                                <col style="width: 15%;">
                                <col style="width: 11%;">
                                <col style="width: 11%;">
                                <col style="width: 11%;">
                                <col style="width: 11%;">
                                <col style="width: 11%;">
                                <col style="width: 8%;">
                            </colgroup>
                            <thead>
                                <tr>
                                    <th>Nº Pedido</th>
                                    <th>Fecha</th>
                                    <th>Tipo de Pedido</th>
                                    <th class="text-end">Base Imponible</th>
                                    <th class="text-end">Comisiones</th>
                                    <th class="text-end">P.C.P.</th>
                                    <th class="text-end">Subtotal</th>
                                    <th class="text-end">Margen</th>
                                    <th class="text-end">% Margen</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (pedidos && pedidos.length > 0) { %>
                                <% 
                                // Función helper para formatear fechas en DD/MM/YYYY
                                function formatearFechaDDMMYYYY(fecha) {
                                    if (!fecha) return '—';
                                    try {
                                        const date = fecha instanceof Date ? fecha : new Date(fecha);
                                        if (isNaN(date.getTime())) return '—';
                                        const dia = String(date.getDate()).padStart(2, '0');
                                        const mes = String(date.getMonth() + 1).padStart(2, '0');
                                        const año = date.getFullYear();
                                        return `${dia}/${mes}/${año}`;
                                    } catch (e) {
                                        return '—';
                                    }
                                }
                                %>
                                <% pedidos.forEach(pedido => { %>
                                <% 
                                const fecha = formatearFechaDDMMYYYY(pedido.FechaPedido);
                                const precioCompra = parseFloat(pedido.PrecioCompra || 0);
                                const baseImponible = parseFloat(pedido.BaseImponible || 0);
                                const comision = parseFloat(pedido.Comision || 0);
                                const subtotal = baseImponible - comision;
                                const margen = subtotal - precioCompra;
                                // Calcular porcentaje de margen sobre el subtotal
                                const porcentajeMargen = subtotal !== 0 ? (margen / subtotal) * 100 : 0;
                                // Determinar clase de color para margen
                                const claseMargen = margen >= 0 ? 'text-success' : 'text-danger';
                                const tipoPedido = pedido.TipoPedido || '—';
                                %>
                                <tr>
                                    <td><strong><%= pedido.NumPedido || '-' %></strong></td>
                                    <td><%= fecha %></td>
                                    <td><%= tipoPedido %></td>
                                    <td class="text-end">€ <%= baseImponible.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, '.') %></td>
                                    <td class="text-end text-success"><strong>€ <%= comision.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, '.') %></strong></td>
                                    <td class="text-end text-info"><strong>€ <%= precioCompra.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, '.') %></strong></td>
                                    <td class="text-end"><strong>€ <%= subtotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, '.') %></strong></td>
                                    <td class="text-end <%= claseMargen %>"><strong>€ <%= margen.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, '.') %></strong></td>
                                    <td class="text-end <%= claseMargen %>"><strong><%= porcentajeMargen.toFixed(2) %>%</strong></td>
                                </tr>
                                <% }) %>
                                
                                <!-- Línea de totales -->
                                <% if (pedidos && pedidos.length > 0) { %>
                                <% 
                                // Calcular totales
                                let totalBaseImponible = 0;
                                let totalComisiones = 0;
                                let totalPCP = 0;
                                let totalSubtotal = 0;
                                let totalMargen = 0;
                                
                                pedidos.forEach(pedido => {
                                    totalBaseImponible += parseFloat(pedido.BaseImponible || 0);
                                    totalComisiones += parseFloat(pedido.Comision || 0);
                                    totalPCP += parseFloat(pedido.PrecioCompra || 0);
                                    const subtotal = parseFloat(pedido.BaseImponible || 0) - parseFloat(pedido.Comision || 0);
                                    totalSubtotal += subtotal;
                                    totalMargen += subtotal - parseFloat(pedido.PrecioCompra || 0);
                                });
                                
                                const porcentajeMargenTotal = totalSubtotal !== 0 ? (totalMargen / totalSubtotal) * 100 : 0;
                                const claseMargenTotal = totalMargen >= 0 ? 'text-success' : 'text-danger';
                                %>
                                <tr class="table-info fw-bold">
                                    <td colspan="3" class="text-end"><strong>TOTALES:</strong></td>
                                    <td class="text-end"><strong>€ <%= totalBaseImponible.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, '.') %></strong></td>
                                    <td class="text-end text-success"><strong>€ <%= totalComisiones.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, '.') %></strong></td>
                                    <td class="text-end text-info"><strong>€ <%= totalPCP.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, '.') %></strong></td>
                                    <td class="text-end"><strong>€ <%= totalSubtotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, '.') %></strong></td>
                                    <td class="text-end <%= claseMargenTotal %>"><strong>€ <%= totalMargen.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, '.') %></strong></td>
                                    <td class="text-end <%= claseMargenTotal %>"><strong><%= porcentajeMargenTotal.toFixed(2) %>%</strong></td>
                                </tr>
                                <% } %>
                                
                                <% } else { %>
                                <tr>
                                    <td colspan="9" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                                        No hay pedidos que coincidan con los filtros
                                    </td>
                                </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
