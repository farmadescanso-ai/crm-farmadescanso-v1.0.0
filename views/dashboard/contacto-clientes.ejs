<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/colors.css" rel="stylesheet">
    <link href="/css/dashboard.css" rel="stylesheet">
    <style>
        .table-container { max-height: 70vh; overflow: auto; border: 1px solid #dee2e6; border-radius: 0.75rem; }
        .table th { position: sticky; top: 0; background-color: #fff; z-index: 10; border-bottom: 2px solid #dee2e6; }
    </style>

    <%- include('../partials/navbar-styles') %></head>
<body>
    <%- include('../partials/navbar-dashboard') %>

    <div class="container-fluid mt-4">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <div>
                <h1 class="mb-0 text-primary">
                    <i class="fas fa-link me-1 text-primary"></i>
                    Clientes del contacto #<%= contacto.Id %>
                </h1>
                <p class="text-muted mb-0"><%= (contacto.Apellidos ? (contacto.Apellidos + ', ') : '') + (contacto.Nombre || '') %></p>
            </div>
            <div class="d-flex gap-2">
                <a class="btn btn-outline-secondary" href="/dashboard/contactos/<%= contacto.Id %>">
                    <i class="fas fa-eye me-1"></i>Ver contacto
                </a>
                <a class="btn btn-secondary" href="/dashboard/contactos">
                    <i class="fas fa-arrow-left me-1"></i>Volver
                </a>
            </div>
        </div>

        <% if (query && query.success) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>Operación realizada correctamente.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <% } %>
        <% if (error || (query && query.error)) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i><%= error || 'No se pudo completar la acción solicitada.' %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <% } %>

        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title mb-3"><i class="fas fa-plus me-2"></i>Vincular a un cliente</h5>
                <form method="POST" id="formVincularCliente" action="/dashboard/contactos/<%= contacto.Id %>/clientes/vincular" class="row g-2 align-items-end">
                    <div class="col-md-5">
                        <label class="form-label">Buscar cliente</label>
                        <div class="position-relative">
                            <input type="text" id="clienteSearchInput" class="form-control" autocomplete="off" placeholder="Escribe 2+ caracteres (nombre, email, teléfono...)">
                            <input type="hidden" name="clienteId" id="clienteIdHidden" value="">
                            <div id="clienteSearchDropdown" class="list-group position-absolute w-100 shadow-sm"
                                 style="top: 100%; z-index: 1050; max-height: 320px; overflow-y: auto; display: none;"></div>
                        </div>
                        <small class="text-muted d-block mt-1">
                            <i class="fas fa-search me-1"></i>Selecciona un cliente del desplegable para rellenar el ID automáticamente.
                        </small>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Rol</label>
                        <input type="text" name="Rol" class="form-control" placeholder="Titular / Odontólogo / ..." />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Principal</label>
                        <select name="Es_Principal" class="form-select">
                            <option value="0" selected>No</option>
                            <option value="1">Sí</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-link me-1"></i>Vincular
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="table-container">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Cliente</th>
                        <th>Rol</th>
                        <th>Principal</th>
                        <th>Vigente</th>
                        <th>Desde</th>
                        <th>Hasta</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (!relaciones || relaciones.length === 0) { %>
                        <tr><td colspan="7" class="text-center text-muted py-4">No hay clientes vinculados</td></tr>
                    <% } else { %>
                        <% relaciones.forEach(function(r) { %>
                            <% const activo = (r.VigenteHasta === null || r.VigenteHasta === undefined); %>
                            <% const nombreCliente = r.Nombre_Razon_Social || r.Nombre || r.nombre || ('Cliente #' + (r.Id_Cliente || '')); %>
                            <tr>
                                <td>
                                    <strong><%= nombreCliente %></strong>
                                    <div class="text-muted small">ID: <%= r.Id_Cliente %></div>
                                </td>
                                <td><%= r.Rol || '—' %></td>
                                <td><%= Number(r.Es_Principal) === 1 ? 'Sí' : 'No' %></td>
                                <td>
                                    <% if (activo) { %><span class="badge bg-success">Activa</span><% } else { %><span class="badge bg-secondary">Histórica</span><% } %>
                                </td>
                                <td><%= r.VigenteDesde ? new Date(r.VigenteDesde).toLocaleString('es-ES') : '—' %></td>
                                <td><%= r.VigenteHasta ? new Date(r.VigenteHasta).toLocaleString('es-ES') : '—' %></td>
                                <td class="text-center">
                                    <div class="btn-group" role="group">
                                        <a class="btn btn-sm btn-outline-primary" title="Ver cliente" href="/dashboard/clientes/<%= r.Id_Cliente %>"><i class="fas fa-eye"></i></a>
                                        <a class="btn btn-sm btn-outline-info" title="Ver contactos del cliente" href="/dashboard/clientes/<%= r.Id_Cliente %>/contactos"><i class="fas fa-address-book"></i></a>
                                        <% if (activo) { %>
                                            <form method="POST" action="/dashboard/contactos/<%= contacto.Id %>/clientes/<%= r.Id_Cliente %>/cerrar" class="d-inline" onsubmit="return confirm('¿Cerrar vínculo activo?');">
                                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Cerrar vínculo"><i class="fas fa-unlink"></i></button>
                                            </form>
                                        <% } %>
                                    </div>
                                </td>
                            </tr>
                        <% }) %>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Autocomplete de clientes via /api/clientes/buscar
        (function() {
            const input = document.getElementById('clienteSearchInput');
            const hiddenId = document.getElementById('clienteIdHidden');
            const dropdown = document.getElementById('clienteSearchDropdown');
            const form = document.getElementById('formVincularCliente');
            if (!input || !hiddenId || !dropdown || !form) return;

            let t = null;
            let lastQuery = '';

            const hide = () => { dropdown.style.display = 'none'; dropdown.innerHTML = ''; };
            const show = () => { dropdown.style.display = 'block'; };

            const escapeHtml = (s) => String(s ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');

            async function fetchClientes(q) {
                const url = `/api/clientes/buscar?q=${encodeURIComponent(q)}&estadoCliente=2&limit=20`;
                const res = await fetch(url, { credentials: 'include' });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    const details = data && (data.details || data.error) ? (data.details || data.error) : `HTTP ${res.status}`;
                    throw new Error(details);
                }
                return (data.clientes || []);
            }

            function selectCliente(c) {
                const id = c.Id ?? c.id;
                const nombre = c.Nombre_Razon_Social || c.Nombre || '-';
                const pobl = c.Poblacion || '';
                const cp = c.CodigoPostal || '';
                const meta = [cp, pobl].filter(Boolean).join(' ');

                hiddenId.value = String(id || '');
                input.value = meta ? `${nombre} (${meta})` : `${nombre}`;
                hide();
            }

            function render(clientes) {
                if (!Array.isArray(clientes) || clientes.length === 0) {
                    dropdown.innerHTML = `<div class="list-group-item text-muted small">No se encontraron clientes</div>`;
                    show();
                    return;
                }
                dropdown.innerHTML = clientes.map(c => {
                    const id = c.Id ?? c.id;
                    const nombre = c.Nombre_Razon_Social || c.Nombre || '-';
                    const dni = c.DNI_CIF || '';
                    const pobl = c.Poblacion || '';
                    const cp = c.CodigoPostal || '';
                    const dir = c.Direccion || '';
                    const meta = [dni, cp, pobl].filter(Boolean).join(' · ');
                    const meta2 = dir ? dir : '';
                    return `
                        <button type="button" class="list-group-item list-group-item-action" data-id="${escapeHtml(id)}">
                            <div class="fw-semibold">${escapeHtml(nombre)}</div>
                            ${meta ? `<div class="text-muted small">${escapeHtml(meta)}</div>` : ''}
                            ${meta2 ? `<div class="text-muted small">${escapeHtml(meta2)}</div>` : ''}
                            <div class="small mt-1"><span class="badge bg-secondary">ID ${escapeHtml(id)}</span></div>
                        </button>
                    `;
                }).join('');
                show();

                dropdown.querySelectorAll('button[data-id]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.getAttribute('data-id');
                        const c = (clientes || []).find(x => String(x.Id ?? x.id) === String(id));
                        if (c) selectCliente(c);
                    });
                });
            }

            input.addEventListener('input', () => {
                const q = String(input.value || '').trim();
                // Si el usuario vuelve a escribir, consideramos que no hay selección válida aún
                hiddenId.value = '';

                if (q.length < 2) {
                    lastQuery = q;
                    hide();
                    return;
                }
                if (q === lastQuery) return;
                lastQuery = q;
                clearTimeout(t);
                t = setTimeout(async () => {
                    dropdown.innerHTML = `<div class="list-group-item text-muted small"><i class="fas fa-spinner fa-spin me-2"></i>Buscando...</div>`;
                    show();
                    try {
                        const clientes = await fetchClientes(q);
                        render(clientes);
                    } catch (e) {
                        dropdown.innerHTML = `<div class="list-group-item text-danger small">Error buscando clientes: ${escapeHtml(e.message || 'desconocido')}</div>`;
                        show();
                    }
                }, 250);
            }, { passive: true });

            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target) && e.target !== input) hide();
            });

            form.addEventListener('submit', (e) => {
                const id = String(hiddenId.value || '').trim();
                if (!id) {
                    e.preventDefault();
                    alert('Por favor, selecciona un cliente del desplegable antes de vincular.');
                }
            });
        })();
    </script>
    <script src="/js/go-to-top.js"></script>

    <!-- Go to Top Button -->
    <button id="goToTop" class="go-to-top" title="Ir arriba">
        <i class="fas fa-arrow-up"></i>
    </button>
</body>
</html>

