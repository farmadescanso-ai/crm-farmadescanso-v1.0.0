<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/colors.css" rel="stylesheet">
    <link href="/css/dashboard.css" rel="stylesheet">
    <style>
        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        .spinner-border-custom {
            width: 4rem;
            height: 4rem;
            border-width: 0.5rem;
        }
        .progress-container {
            margin-top: 2rem;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }
    </style>

    <%- include('../partials/navbar-styles') %></head>
<body>
    <%- include('../partials/navbar-dashboard') %>

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card shadow-lg border-0">
                    <div class="card-body text-center p-5">
                        <div class="spinner-container mb-4">
                            <div class="spinner-border spinner-border-custom text-primary pulse" role="status">
                                <span class="visually-hidden">Procesando...</span>
                            </div>
                        </div>
                        
                        <h3 class="text-primary mb-3">
                            <i class="fas fa-clock me-2"></i>Espere guardando la Cita
                        </h3>
                        
                        <p class="text-muted mb-4">
                            Estamos procesando su cita y estableciendo las relaciones necesarias.
                            Por favor, espere un momento...
                        </p>
                        
                        <div class="progress-container">
                            <div class="progress" style="height: 25px;">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                     role="progressbar" 
                                     style="width: 0%" 
                                     aria-valuenow="0" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    <span id="progressText">0%</span>
                                </div>
                            </div>
                            <small class="text-muted mt-2 d-block" id="statusText">
                                Iniciando procesamiento...
                            </small>
                        </div>
                        
                        <div id="errorMessage" class="alert alert-danger mt-4" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="errorText"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const procesoId = '<%= procesoId %>';
        let intentos = 0;
        const maxIntentos = 60; // 60 intentos = 60 segundos (1 segundo por intento)
        let intervaloPolling = null;
        
        // Función para actualizar la barra de progreso
        function actualizarProgreso(porcentaje, texto) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const statusText = document.getElementById('statusText');
            
            progressBar.style.width = porcentaje + '%';
            progressBar.setAttribute('aria-valuenow', porcentaje);
            progressText.textContent = porcentaje + '%';
            statusText.textContent = texto || 'Procesando...';
        }
        
        // Variable para controlar si el proceso está completado
        let procesoCompletado = false;
        
        // Función para verificar el estado del procesamiento
        async function verificarEstado() {
          try {
            intentos++;
            
            // Simular progreso gradual (0% a 90%)
            const progresoSimulado = Math.min(90, (intentos / maxIntentos) * 90);
            actualizarProgreso(
              Math.round(progresoSimulado),
              `Procesando... (${intentos}s)`
            );
            
            const response = await fetch(`/api/visita/proceso/estado?procesoId=${procesoId}`);
            
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.estado === 'completado' || data.estado === 'success') {
              // Proceso completado exitosamente
              procesoCompletado = true;
              actualizarProgreso(100, '¡Proceso completado!');
              
              if (intervaloPolling) {
                clearInterval(intervaloPolling);
                intervaloPolling = null;
              }
              
              // Desactivar el evento beforeunload para permitir la redirección sin confirmación
              window.removeEventListener('beforeunload', preventLeave);
              
              // Esperar un momento para mostrar el 100% y luego redirigir
              setTimeout(() => {
                // Usar replace en lugar de href para evitar el diálogo de confirmación
                window.location.replace('/dashboard/agenda?success=cita_creada');
              }, 1000);
              
            } else if (data.estado === 'error' || data.error) {
              // Error en el procesamiento
              procesoCompletado = true;
              mostrarError(data.error || 'Error desconocido al procesar la cita');
              
              if (intervaloPolling) {
                clearInterval(intervaloPolling);
                intervaloPolling = null;
              }
              
              // Desactivar el evento beforeunload
              window.removeEventListener('beforeunload', preventLeave);
              
              // Redirigir después de mostrar el error
              setTimeout(() => {
                window.location.replace('/dashboard/agenda/nuevo?error=error_procesando_cita');
              }, 3000);
              
            } else if (intentos >= maxIntentos) {
              // Timeout - demasiados intentos
              procesoCompletado = true;
              mostrarError('El proceso está tomando más tiempo del esperado. Por favor, verifique manualmente el estado de la cita.');
              
              if (intervaloPolling) {
                clearInterval(intervaloPolling);
                intervaloPolling = null;
              }
              
              // Desactivar el evento beforeunload
              window.removeEventListener('beforeunload', preventLeave);
              
              // Redirigir después del timeout
              setTimeout(() => {
                window.location.replace('/dashboard/agenda?timeout=procesamiento_prolongado');
              }, 5000);
            }
            
          } catch (error) {
            console.error('Error verificando estado:', error);
            
            if (intentos >= maxIntentos) {
              procesoCompletado = true;
              mostrarError('Error al verificar el estado del procesamiento. Por favor, verifique manualmente.');
              
              if (intervaloPolling) {
                clearInterval(intervaloPolling);
                intervaloPolling = null;
              }
              
              // Desactivar el evento beforeunload
              window.removeEventListener('beforeunload', preventLeave);
              
              setTimeout(() => {
                window.location.replace('/dashboard/agenda?error=error_verificando_estado');
              }, 3000);
            }
          }
        }
        
        // Función para mostrar errores
        function mostrarError(mensaje) {
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            
            errorText.textContent = mensaje;
            errorMessage.style.display = 'block';
            actualizarProgreso(0, 'Error en el procesamiento');
        }
        
        // Iniciar polling cada segundo
        actualizarProgreso(10, 'Enviando datos a N8N...');
        
        // Esperar un momento antes de empezar el polling (dar tiempo a que N8N reciba el webhook)
        setTimeout(() => {
            intervaloPolling = setInterval(verificarEstado, 1000); // Verificar cada segundo
            
            // También verificar inmediatamente
            verificarEstado();
        }, 2000);
        
        // Función para prevenir que el usuario navegue fuera de la página mientras se procesa
        function preventLeave(e) {
          // Solo prevenir si el proceso no está completado y hay polling activo
          if (!procesoCompletado && intervaloPolling) {
            e.preventDefault();
            e.returnValue = '¿Está seguro de que desea salir? El procesamiento de la cita puede estar en curso.';
            return e.returnValue;
          }
          // Si el proceso está completado o no hay polling, permitir salir sin confirmación
        }
        
        // Prevenir que el usuario navegue fuera de la página mientras se procesa
        window.addEventListener('beforeunload', preventLeave);
    </script>
    <script src="/js/go-to-top.js"></script>

    <!-- Go to Top Button -->
    <button id="goToTop" class="go-to-top" title="Ir arriba">
        <i class="fas fa-arrow-up"></i>
    </button>
</body>
</html>

