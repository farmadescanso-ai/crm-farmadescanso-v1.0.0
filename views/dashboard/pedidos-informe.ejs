<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/colors.css" rel="stylesheet">
    <link href="/css/dashboard.css" rel="stylesheet">
    <style>
        @media print {
            .no-print {
                display: none !important;
            }
            .page-break {
                page-break-after: always;
            }
            body {
                font-size: 12px;
            }
            .card {
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }
        }
        .informe-header {
            background: linear-gradient(135deg, #0b891b 0%, #0d6efd 100%);
            color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            margin-bottom: 2rem;
        }
        .estadistica-card {
            border-left: 4px solid #0b891b;
            transition: transform 0.2s;
        }
        .estadistica-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .pedido-card {
            margin-bottom: 2rem;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
        }
        .pedido-header {
            background-color: #f8f9fa;
            border-bottom: 2px solid #0b891b;
            padding: 1rem 1.5rem;
        }
        .linea-item {
            border-bottom: 1px solid #e9ecef;
            padding: 0.75rem 0;
        }
        .linea-item:last-child {
            border-bottom: none;
        }
        .badge-estado {
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
        }
    </style>

    <%- include('../partials/navbar-styles') %></head>
<body>
    <%- include('../partials/navbar-dashboard') %>

    <div class="container py-4">
        <!-- Encabezado del informe -->
        <div class="informe-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2"><i class="fas fa-file-alt me-2"></i>Informe Completo de Pedidos</h1>
                    <p class="mb-0">Generado el <%= fechaGeneracion.toLocaleDateString('es-ES', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) %></p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="bg-white bg-opacity-25 rounded p-3">
                        <div class="h4 mb-0"><%= estadisticas.totalPedidos %></div>
                        <small>Total Pedidos</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estadísticas generales -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card estadistica-card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-muted small text-uppercase">Total Importe</div>
                                <div class="h4 mb-0 text-success">
                                    € <%= formatearMonedaES(estadisticas.totalImporte, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
                                </div>
                            </div>
                            <i class="fas fa-euro-sign fa-2x text-success opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card estadistica-card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-muted small text-uppercase">Base Imponible</div>
                                <div class="h4 mb-0 text-primary">
                                    € <%= formatearMonedaES(estadisticas.totalBaseImponible, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
                                </div>
                            </div>
                            <i class="fas fa-calculator fa-2x text-primary opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card estadistica-card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-muted small text-uppercase">Total IVA</div>
                                <div class="h4 mb-0 text-info">
                                    € <%= formatearMonedaES(estadisticas.totalIva, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
                                </div>
                            </div>
                            <i class="fas fa-percent fa-2x text-info opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card estadistica-card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="text-muted small text-uppercase">Total Líneas</div>
                                <div class="h4 mb-0 text-warning">
                                    <%= formatearNumeroES(estadisticas.totalLineas) %>
                                </div>
                            </div>
                            <i class="fas fa-list fa-2x text-warning opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resumen por estados -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <div class="h3 mb-0 text-warning"><%= estadisticas.pendientes %></div>
                        <small class="text-muted">Pendientes</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <div class="h3 mb-0 text-success"><%= estadisticas.completados %></div>
                        <small class="text-muted">Completados</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-secondary">
                    <div class="card-body text-center">
                        <div class="h3 mb-0 text-secondary"><%= estadisticas.cancelados %></div>
                        <small class="text-muted">Cancelados</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-primary">
                    <div class="card-body text-center">
                        <div class="h3 mb-0 text-primary"><%= estadisticas.cerrados %></div>
                        <small class="text-muted">Cerrados</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Listado detallado de pedidos -->
        <div class="mb-4">
            <h2 class="mb-3"><i class="fas fa-list me-2"></i>Detalle de Pedidos</h2>
            
            <% if (pedidos.length === 0) { %>
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>No hay pedidos registrados.
            </div>
            <% } else { %>
                <% pedidos.forEach((pedido, index) => { %>
                <div class="card pedido-card">
                    <div class="pedido-header">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h4 class="mb-1">
                                    <i class="fas fa-shopping-cart me-2"></i>Pedido <%= pedido.numero %>
                                    <% 
                                    // Función para obtener la clase CSS según el estado del pedido
                                    function getEstadoClass(estado) {
                                        if (!estado) return 'bg-secondary';
                                        const estadoLower = estado.toLowerCase();
                                        
                                        if (estadoLower === 'pendiente' || estadoLower.includes('pend')) {
                                            return 'bg-warning text-dark';
                                        } else if (estadoLower === 'tramitado' || estadoLower.includes('tramit')) {
                                            return 'bg-info text-white';
                                        } else if (estadoLower === 'enviado' || estadoLower.includes('envi')) {
                                            return 'bg-primary text-white';
                                        } else if (estadoLower === 'entregado' || estadoLower.includes('entreg')) {
                                            return 'bg-success text-white';
                                        } else if (estadoLower === 'cancelado' || estadoLower === 'anulado' || estadoLower.includes('cancel') || estadoLower.includes('anul')) {
                                            return 'bg-secondary text-white';
                                        } else if (estadoLower === 'cerrado' || estadoLower.includes('cerr')) {
                                            return 'bg-dark text-white';
                                        } else {
                                            return 'bg-secondary text-white';
                                        }
                                    }
                                    const estadoPedido = pedido.estado || 'Pendiente';
                                    const estadoClass = getEstadoClass(estadoPedido);
                                    %>
                                    <span class="badge badge-estado <%= estadoClass %>">
                                        <%= estadoPedido %>
                                    </span>
                                </h4>
                                <small class="text-muted">
                                    <% 
                                    // Función helper para formatear fechas en DD/MM/YYYY
                                    function formatearFechaDDMMYYYY(fecha) {
                                        if (!fecha) return '—';
                                        try {
                                            const date = fecha instanceof Date ? fecha : new Date(fecha);
                                            if (isNaN(date.getTime())) return '—';
                                            const dia = String(date.getDate()).padStart(2, '0');
                                            const mes = String(date.getMonth() + 1).padStart(2, '0');
                                            const año = date.getFullYear();
                                            return `${dia}/${mes}/${año}`;
                                        } catch (e) {
                                            return '—';
                                        }
                                    }
                                    %>
                                    ID: <%= pedido.id %> | 
                                    Fecha: <%= formatearFechaDDMMYYYY(pedido.fecha) %>
                                    <% if (pedido.fechaEntrega) { %>
                                        | Entrega: <%= formatearFechaDDMMYYYY(pedido.fechaEntrega) %>
                                    <% } %>
                                </small>
                            </div>
                            <div class="col-md-6 text-end">
                                <div class="h5 mb-0 text-success">
                                    Total: € <%= formatearMonedaES(pedido.totales.total, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
                                </div>
                                <small class="text-muted"><%= pedido.lineas.length %> línea(s)</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <!-- Información del cliente -->
                        <% if (pedido.cliente) { %>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6 class="text-primary"><i class="fas fa-user me-2"></i>Cliente</h6>
                                <p class="mb-1"><strong><%= pedido.cliente.nombre %></strong></p>
                                <% if (pedido.cliente.dni) { %>
                                    <p class="mb-1 text-muted small">DNI/CIF: <%= pedido.cliente.dni %></p>
                                <% } %>
                                <% if (pedido.cliente.email) { %>
                                    <p class="mb-1 text-muted small"><i class="fas fa-envelope me-1"></i><%= pedido.cliente.email %></p>
                                <% } %>
                                <% if (pedido.cliente.telefono) { %>
                                    <p class="mb-1 text-muted small"><i class="fas fa-phone me-1"></i><%= pedido.cliente.telefono %></p>
                                <% } %>
                                <% if (pedido.cliente.direccion || pedido.cliente.poblacion) { %>
                                    <p class="mb-0 text-muted small">
                                        <i class="fas fa-map-marker-alt me-1"></i>
                                        <%= [pedido.cliente.direccion, pedido.cliente.poblacion, pedido.cliente.provincia, pedido.cliente.codigoPostal].filter(Boolean).join(', ') %>
                                    </p>
                                <% } %>
                            </div>
                            <div class="col-md-6">
                                <% if (pedido.comercial) { %>
                                    <h6 class="text-primary"><i class="fas fa-user-tie me-2"></i>Comercial</h6>
                                    <p class="mb-1"><strong><%= pedido.comercial.nombre %></strong></p>
                                    <% if (pedido.comercial.email) { %>
                                        <p class="mb-0 text-muted small"><i class="fas fa-envelope me-1"></i><%= pedido.comercial.email %></p>
                                    <% } %>
                                <% } %>
                                
                                <% if (pedido.formaPago) { %>
                                    <h6 class="text-primary mt-3"><i class="fas fa-credit-card me-2"></i>Forma de Pago</h6>
                                    <p class="mb-0"><%= pedido.formaPago.nombre %><% if (pedido.formaPago.dias) { %> (<%= pedido.formaPago.dias %> días)<% } %></p>
                                <% } %>
                                
                                <% if (pedido.tipoPedido) { %>
                                    <h6 class="text-primary mt-3"><i class="fas fa-tag me-2"></i>Tipo de Pedido</h6>
                                    <p class="mb-0"><%= pedido.tipoPedido.nombre %></p>
                                    <% if (pedido.tipoPedido.nombre && pedido.tipoPedido.nombre.toLowerCase().includes('transfer') && (pedido.cooperativa_nombre || pedido.numero_cooperativa)) { %>
                                        <p class="mb-0 text-muted small mt-1">
                                            Cooperativa: <strong><%= pedido.cooperativa_nombre || '—' %></strong>
                                            <% if (pedido.numero_cooperativa) { %>
                                                | Nº Asociado: <strong><%= pedido.numero_cooperativa %></strong>
                                            <% } %>
                                        </p>
                                    <% } %>
                                <% } %>
                            </div>
                        </div>
                        <% } %>

                        <!-- Líneas del pedido -->
                        <% if (pedido.lineas && pedido.lineas.length > 0) { %>
                        <div class="mb-3">
                            <h6 class="text-primary"><i class="fas fa-list me-2"></i>Líneas del Pedido</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Artículo</th>
                                            <th class="text-center">Cantidad</th>
                                            <th class="text-end">Precio Unit.</th>
                                            <th class="text-center">Descuento</th>
                                            <th class="text-end">Subtotal</th>
                                            <th class="text-center">IVA</th>
                                            <th class="text-end">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% pedido.lineas.forEach(linea => { %>
                                        <tr class="linea-item">
                                            <td>
                                                <strong><%= linea.articulo || 'Artículo desconocido' %></strong>
                                                <% if (linea.articuloId) { %>
                                                    <br><small class="text-muted">ID: <%= linea.articuloId %></small>
                                                <% } %>
                                            </td>
                                            <td class="text-center"><%= formatearNumeroES(linea.cantidad || 0) %></td>
                                            <td class="text-end">€ <%= formatearMonedaES(linea.precio || 0, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                                            <td class="text-center">
                                                <% if (linea.descuento && linea.descuento > 0) { %>
                                                    <%= formatearNumeroES(linea.descuento) %>%<br>
                                                    <small class="text-muted">(-€ <%= formatearMonedaES(linea.descuentoValor || 0, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>)</small>
                                                <% } else { %>
                                                    —
                                                <% } %>
                                            </td>
                                            <td class="text-end">€ <%= formatearMonedaES(linea.subtotal || 0, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                                            <td class="text-center"><%= formatearNumeroES(linea.iva || 0) %>%</td>
                                            <td class="text-end fw-semibold">€ <%= formatearMonedaES(linea.total || 0, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                                        </tr>
                                        <% }) %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <% } else { %>
                        <div class="alert alert-warning mb-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>Este pedido no tiene líneas asociadas.
                        </div>
                        <% } %>

                        <!-- Totales -->
                        <div class="row">
                            <div class="col-md-6">
                                <% if (pedido.observaciones) { %>
                                <div class="mb-3">
                                    <h6 class="text-primary"><i class="fas fa-sticky-note me-2"></i>Observaciones</h6>
                                    <div class="alert alert-secondary mb-0">
                                        <%= pedido.observaciones %>
                                    </div>
                                </div>
                                <% } %>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">Resumen de Totales</h6>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Subtotal:</span>
                                            <strong>€ <%= formatearMonedaES(pedido.totales.subtotal, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></strong>
                                        </div>
                                        <% if (pedido.totales.descuentos > 0) { %>
                                        <div class="d-flex justify-content-between mb-2 text-danger">
                                            <span>Descuentos:</span>
                                            <strong>-€ <%= formatearMonedaES(pedido.totales.descuentos, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></strong>
                                        </div>
                                        <% } %>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>IVA:</span>
                                            <strong>€ <%= formatearMonedaES(pedido.totales.iva, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></strong>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between">
                                            <span class="h5 mb-0">Total:</span>
                                            <span class="h5 mb-0 text-success">€ <%= formatearMonedaES(pedido.totales.total, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <% if ((index + 1) % 3 === 0) { %>
                    <div class="page-break"></div>
                <% } %>
                <% }) %>
            <% } %>
        </div>

        <!-- Pie del informe -->
        <div class="text-center text-muted mt-4 mb-4 no-print">
            <hr>
            <p class="mb-0">
                <small>
                    Informe generado el <%= fechaGeneracion.toLocaleDateString('es-ES', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) %> | 
                    Total de pedidos: <%= estadisticas.totalPedidos %> | 
                    Usuario: <%= user.Nombre || user.nombre || user.Email || 'Usuario' %>
                </small>
            </p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">    </script>
    <script src="/js/go-to-top.js"></script>

    <!-- Go to Top Button -->
    <button id="goToTop" class="go-to-top" title="Ir arriba">
        <i class="fas fa-arrow-up"></i>
    </button>
</body>
</html>

