<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ajustes - <%= title %></title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/colors.css" rel="stylesheet">
    <link href="/css/dashboard.css" rel="stylesheet">
    <style>
        .nav-pills .nav-link {
            color: #495057;
        }
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
        }
        .section-card {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }
    </style>

    <%- include('../partials/navbar-styles') %></head>
<body>
    <!-- Navigation -->
    <%- include('../partials/navbar-dashboard') %>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-cog me-2"></i>Configuración del Sistema
                        </h4>
                    </div>
                    <div class="card-body">
                        <% if (error) { %>
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <%= error %>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        <% } %>
                        
                        <% if (success) { %>
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                <i class="fas fa-check-circle me-2"></i>
                                <%= success %>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        <% } %>

                        <!-- Tabs Navigation -->
                        <ul class="nav nav-pills mb-4" id="configTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="n8n-tab" data-bs-toggle="tab" data-bs-target="#n8n" type="button" role="tab">
                                    <i class="fas fa-plug me-2"></i>Webhook N8N
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="prestashop-tab" data-bs-toggle="tab" data-bs-target="#prestashop" type="button" role="tab">
                                    <i class="fas fa-shopping-bag me-2"></i>Prestashop
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="api-keys-tab" data-bs-toggle="tab" data-bs-target="#api-keys" type="button" role="tab">
                                    <i class="fas fa-key me-2"></i>API Keys
                                </button>
                            </li>
                        </ul>

                        <form method="POST" action="/dashboard/ajustes" id="ajustesForm">
                            <div class="tab-content" id="configTabsContent">
                                <!-- Tab N8N Webhook -->
                                <div class="tab-pane fade show active" id="n8n" role="tabpanel">
                                    <div class="section-card p-4 mb-4">
                                        <h5 class="mb-4">
                                            <i class="fas fa-plug me-2 text-primary"></i>Configuración del Webhook de N8N
                                        </h5>
                                        
                                        <div class="mb-4">
                                            <label for="webhook_nombre" class="form-label fw-bold">
                                                <i class="fas fa-tag me-2"></i>Nombre del Webhook
                                            </label>
                                            <input 
                                                type="text" 
                                                class="form-control" 
                                                id="webhook_nombre" 
                                                name="webhook_nombre" 
                                                value="<%= configuracion.webhook_nombre || '' %>"
                                                placeholder="Ej: Webhook N8N - Holded"
                                            >
                                            <small class="form-text text-muted">
                                                Nombre identificativo para este webhook (ej: "Webhook N8N - Holded", "Webhook Visitas")
                                            </small>
                                        </div>

                                        <div class="mb-4">
                                            <label for="webhook_url" class="form-label fw-bold">
                                                <i class="fas fa-link me-2"></i>URL del Webhook de N8N
                                            </label>
                                            <input 
                                                type="url" 
                                                class="form-control" 
                                                id="webhook_url" 
                                                name="webhook_url" 
                                                value="<%= configuracion.webhook_url || '' %>"
                                                placeholder="https://tu-instancia-n8n.com/webhook/xxxxx"
                                            >
                                            <small class="form-text text-muted">
                                                URL completa del webhook de N8N que se comunicará con el workflow de Holded
                                            </small>
                                        </div>

                                        <div class="mb-4">
                                            <label class="form-label fw-bold">
                                                <i class="fas fa-key me-2"></i>Autenticación Header (Clave=Valor)
                                            </label>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="auth_header_key" class="form-label">Clave del Header</label>
                                                    <input 
                                                        type="text" 
                                                        class="form-control" 
                                                        id="auth_header_key" 
                                                        name="auth_header_key" 
                                                        value="<%= configuracion.auth_header_key || '' %>"
                                                        placeholder="X-API-Key"
                                                    >
                                                    <small class="form-text text-muted">
                                                        Nombre del header (ej: X-API-Key, Authorization)
                                                    </small>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="auth_header_value" class="form-label">Valor del Header</label>
                                                    <input 
                                                        type="text" 
                                                        class="form-control" 
                                                        id="auth_header_value" 
                                                        name="auth_header_value" 
                                                        value="<%= configuracion.auth_header_value || '' %>"
                                                        placeholder="tu-valor-secreto"
                                                    >
                                                    <small class="form-text text-muted">
                                                        Valor del header de autenticación
                                                    </small>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-4">
                                            <label for="webhook_observaciones" class="form-label fw-bold">
                                                <i class="fas fa-info-circle me-2"></i>Observaciones
                                            </label>
                                            <textarea 
                                                class="form-control" 
                                                id="webhook_observaciones" 
                                                name="webhook_observaciones" 
                                                rows="4"
                                                placeholder="Describe qué hace este webhook, qué datos procesa, cuándo se ejecuta, etc."
                                            ><%= configuracion.webhook_observaciones || '' %></textarea>
                                            <small class="form-text text-muted">
                                                Explica el funcionamiento de este webhook: qué hace, qué datos procesa, cuándo se ejecuta, etc.
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tab Prestashop -->
                                <div class="tab-pane fade" id="prestashop" role="tabpanel">
                                    <div class="section-card p-4 mb-4">
                                        <h5 class="mb-4">
                                            <i class="fas fa-shopping-bag me-2 text-primary"></i>Configuración de Prestashop
                                        </h5>
                                        
                                        <div class="mb-4">
                                            <label for="prestashop_url" class="form-label fw-bold">
                                                <i class="fas fa-link me-2"></i>URL de la Tienda Prestashop
                                            </label>
                                            <input 
                                                type="url" 
                                                class="form-control" 
                                                id="prestashop_url" 
                                                name="prestashop_url" 
                                                value="<%= configuracion.prestashop_url || '' %>"
                                                placeholder="https://tu-tienda-prestashop.com"
                                            >
                                            <small class="form-text text-muted">
                                                URL completa de la tienda Prestashop (sin barra final)
                                            </small>
                                        </div>

                                        <div class="mb-4">
                                            <label for="prestashop_api_key" class="form-label fw-bold">
                                                <i class="fas fa-key me-2"></i>Clave API de Prestashop
                                            </label>
                                            <input 
                                                type="text" 
                                                class="form-control" 
                                                id="prestashop_api_key" 
                                                name="prestashop_api_key" 
                                                value="<%= configuracion.prestashop_api_key || '' %>"
                                                placeholder="Tu clave API de Prestashop"
                                            >
                                            <small class="form-text text-muted">
                                                Clave API generada en Prestashop para autenticación
                                            </small>
                                        </div>

                                        <div class="mb-4">
                                            <label for="prestashop_webservice_key" class="form-label fw-bold">
                                                <i class="fas fa-network-wired me-2"></i>Clave del Webservice de Prestashop
                                            </label>
                                            <input 
                                                type="text" 
                                                class="form-control" 
                                                id="prestashop_webservice_key" 
                                                name="prestashop_webservice_key" 
                                                value="<%= configuracion.prestashop_webservice_key || '' %>"
                                                placeholder="Tu clave del webservice"
                                            >
                                            <small class="form-text text-muted">
                                                Clave del webservice necesaria para las operaciones con Prestashop
                                            </small>
                                        </div>

                                        <div class="mb-4">
                                            <label for="prestashop_observaciones" class="form-label fw-bold">
                                                <i class="fas fa-info-circle me-2"></i>Observaciones
                                            </label>
                                            <textarea 
                                                class="form-control" 
                                                id="prestashop_observaciones" 
                                                name="prestashop_observaciones" 
                                                rows="4"
                                                placeholder="Describe la configuración de Prestashop, qué webservices se utilizan, etc."
                                            ><%= configuracion.prestashop_observaciones || '' %></textarea>
                                            <small class="form-text text-muted">
                                                Información adicional sobre la configuración de Prestashop y los webservices utilizados
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                                <!-- Tab API Keys -->
                                <div class="tab-pane fade" id="api-keys" role="tabpanel">
                                    <div class="section-card p-4 mb-4">
                                        <h5 class="mb-4">
                                            <i class="fas fa-key me-2 text-primary"></i>Gestión de API Keys
                                        </h5>
                                        
                                        <!-- Formulario para generar nueva API Key -->
                                        <div class="card mb-4">
                                            <div class="card-header bg-info text-white">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-plus-circle me-2"></i>Generar Nueva API Key
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <form id="generateApiKeyForm">
                                                    <div class="mb-3">
                                                        <label for="api_key_nombre" class="form-label fw-bold">Nombre</label>
                                                        <input 
                                                            type="text" 
                                                            class="form-control" 
                                                            id="api_key_nombre" 
                                                            name="nombre" 
                                                            placeholder="Ej: API Key para Prestashop"
                                                        >
                                                        <small class="form-text text-muted">
                                                            Nombre identificativo para esta API key
                                                        </small>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="api_key_descripcion" class="form-label">Descripción</label>
                                                        <textarea 
                                                            class="form-control" 
                                                            id="api_key_descripcion" 
                                                            name="descripcion" 
                                                            rows="2"
                                                            placeholder="Describe para qué se usará esta API key"
                                                        ></textarea>
                                                    </div>
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="fas fa-key me-2"></i>Generar API Key
                                                    </button>
                                                </form>
                                            </div>
                                        </div>

                                        <!-- Lista de API Keys existentes -->
                                        <div class="card">
                                            <div class="card-header bg-secondary text-white">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-list me-2"></i>API Keys Existentes
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="apiKeysList">
                                                    <p class="text-muted">Cargando API keys...</p>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Modal para mostrar la API Key generada -->
                                        <div class="modal fade" id="apiKeyModal" tabindex="-1">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header bg-success text-white">
                                                        <h5 class="modal-title">
                                                            <i class="fas fa-check-circle me-2"></i>API Key Generada
                                                        </h5>
                                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <div class="alert alert-warning">
                                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                                            <strong>¡Importante!</strong> Guarda esta API key de forma segura. No se mostrará nuevamente.
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label fw-bold">Tu API Key:</label>
                                                            <div class="input-group">
                                                                <input 
                                                                    type="text" 
                                                                    class="form-control font-monospace" 
                                                                    id="generatedApiKey" 
                                                                    readonly
                                                                >
                                                                <button class="btn btn-outline-secondary" type="button" onclick="copyApiKey()">
                                                                    <i class="fas fa-copy"></i> Copiar
                                                                </button>
                                                            </div>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label fw-bold">Nombre:</label>
                                                            <p id="generatedApiKeyName" class="mb-0"></p>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <a href="/dashboard" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Volver
                                </a>
                                <button type="submit" class="btn btn-primary" form="ajustesForm">
                                    <i class="fas fa-save me-2"></i>Guardar Configuración
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Validación personalizada del formulario para evitar errores con campos en pestañas ocultas
        const ajustesForm = document.getElementById('ajustesForm');
        if (ajustesForm) {
            ajustesForm.addEventListener('submit', function(e) {
                // Deshabilitar validación HTML5 para campos en pestañas ocultas
                const allInputs = ajustesForm.querySelectorAll('input[required], textarea[required], select[required]');
                allInputs.forEach(input => {
                    const tabPane = input.closest('.tab-pane');
                    if (tabPane && !tabPane.classList.contains('active') && !tabPane.classList.contains('show')) {
                        // Campo está en una pestaña oculta, remover required temporalmente
                        input.removeAttribute('required');
                        input.setAttribute('data-was-required', 'true');
                    }
                });
                
                // Validar solo campos visibles si es necesario
                const activeTabPane = ajustesForm.querySelector('.tab-pane.active.show');
                if (activeTabPane) {
                    const requiredFields = activeTabPane.querySelectorAll('input[required], textarea[required], select[required]');
                    let isValid = true;
                    requiredFields.forEach(field => {
                        if (!field.value.trim()) {
                            isValid = false;
                            field.classList.add('is-invalid');
                        } else {
                            field.classList.remove('is-invalid');
                        }
                    });
                    
                    if (!isValid) {
                        e.preventDefault();
                        alert('Por favor, completa todos los campos requeridos en la pestaña actual.');
                        return false;
                    }
                }
                
                // Restaurar required después de la validación
                setTimeout(() => {
                    allInputs.forEach(input => {
                        if (input.getAttribute('data-was-required') === 'true') {
                            input.setAttribute('required', 'required');
                            input.removeAttribute('data-was-required');
                        }
                    });
                }, 100);
            });
        }

        // Esperar a que todo esté cargado antes de ejecutar código
        (function() {
            // Cargar lista de API keys al cargar la página (solo si existe el elemento)
            function initAjustes() {
                try {
                    // Solo cargar API keys si estamos en la pestaña de API Keys o si el elemento existe
                    const apiKeysList = document.getElementById('apiKeysList');
                    if (apiKeysList) {
                        loadApiKeys();
                    }
                    
                    // Configurar formulario de API Key solo si existe
                    const generateForm = document.getElementById('generateApiKeyForm');
                    if (generateForm) {
                        setupApiKeyForm();
                    }
                    
                    // Cargar API keys cuando se activa la pestaña de API Keys
                    // Usar delegación de eventos en el contenedor de tabs para evitar problemas de timing
                    const configTabs = document.getElementById('configTabs');
                    if (configTabs) {
                        configTabs.addEventListener('shown.bs.tab', function(event) {
                            // Verificar si la pestaña activada es la de API Keys
                            if (event.target && event.target.id === 'api-keys-tab') {
                                const listContainer = document.getElementById('apiKeysList');
                                if (listContainer) {
                                    loadApiKeys();
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error inicializando ajustes:', error);
                }
            }
            
            // Ejecutar cuando el DOM esté listo y Bootstrap esté cargado
            function waitForBootstrap() {
                if (typeof bootstrap !== 'undefined' && bootstrap.Tab) {
                    initAjustes();
                } else {
                    // Esperar un poco más si Bootstrap aún no está cargado
                    setTimeout(waitForBootstrap, 100);
                }
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', waitForBootstrap);
            } else {
                // DOM ya está listo
                waitForBootstrap();
            }
        })();

        // Configurar formulario para generar API Key
        function setupApiKeyForm() {
            const generateForm = document.getElementById('generateApiKeyForm');
            if (!generateForm) return;
            
            generateForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                nombre: document.getElementById('api_key_nombre').value,
                descripcion: document.getElementById('api_key_descripcion').value
            };

            try {
                const response = await fetch('/api/keys/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    // Mostrar la API key en el modal
                    document.getElementById('generatedApiKey').value = data.data.api_key;
                    document.getElementById('generatedApiKeyName').textContent = data.data.nombre;
                    
                    const modal = new bootstrap.Modal(document.getElementById('apiKeyModal'));
                    modal.show();
                    
                    // Limpiar formulario
                    document.getElementById('generateApiKeyForm').reset();
                    
                    // Recargar lista
                    loadApiKeys();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo generar la API key'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al generar la API key: ' + error.message);
            }
            });
        }

        // Función para copiar API key
        function copyApiKey() {
            const apiKeyInput = document.getElementById('generatedApiKey');
            if (!apiKeyInput) return;
            
            apiKeyInput.select();
            document.execCommand('copy');
            
            const btn = event.target.closest('button');
            if (btn) {
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copiado';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-outline-secondary');
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-secondary');
                }, 2000);
            }
        }

        // Cargar lista de API keys
        async function loadApiKeys() {
            const listContainer = document.getElementById('apiKeysList');
            if (!listContainer) return;
            
            try {
                const response = await fetch('/api/keys');
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    let html = '<div class="table-responsive"><table class="table table-striped">';
                    html += '<thead><tr><th>Nombre</th><th>Descripción</th><th>Estado</th><th>Creada</th><th>Último Uso</th><th>Acciones</th></tr></thead><tbody>';
                    
                    data.data.forEach(key => {
                        const fechaCreacion = key.creado_en ? new Date(key.creado_en).toLocaleDateString('es-ES') : '-';
                        const ultimoUso = key.ultimo_uso ? new Date(key.ultimo_uso).toLocaleDateString('es-ES') : 'Nunca';
                        const estadoBadge = key.activa 
                            ? '<span class="badge bg-success">Activa</span>' 
                            : '<span class="badge bg-secondary">Inactiva</span>';
                        
                        html += `<tr>
                            <td>${key.nombre || '-'}</td>
                            <td>${key.descripcion || '-'}</td>
                            <td>${estadoBadge}</td>
                            <td>${fechaCreacion}</td>
                            <td>${ultimoUso}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="toggleApiKey(${key.id}, ${!key.activa})">
                                    <i class="fas fa-${key.activa ? 'ban' : 'check'}"></i> ${key.activa ? 'Desactivar' : 'Activar'}
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteApiKey(${key.id})">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table></div>';
                    listContainer.innerHTML = html;
                } else {
                    listContainer.innerHTML = '<p class="text-muted">No hay API keys generadas aún.</p>';
                }
            } catch (error) {
                console.error('Error cargando API keys:', error);
                const listContainer = document.getElementById('apiKeysList');
                if (listContainer) {
                    listContainer.innerHTML = '<p class="text-danger">Error al cargar las API keys.</p>';
                }
            }
        }

        // Toggle API key
        async function toggleApiKey(id, activa) {
            if (!confirm(`¿Estás seguro de que quieres ${activa ? 'activar' : 'desactivar'} esta API key?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/keys/${id}/toggle`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ activa: activa })
                });

                const data = await response.json();

                if (data.success) {
                    loadApiKeys();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo actualizar la API key'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al actualizar la API key: ' + error.message);
            }
        }

        // Eliminar API key
        async function deleteApiKey(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar esta API key? Esta acción no se puede deshacer.')) {
                return;
            }

            try {
                const response = await fetch(`/api/keys/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    loadApiKeys();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo eliminar la API key'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar la API key: ' + error.message);
            }
        }
    </script>
    <script src="/js/go-to-top.js"></script>

    <!-- Go to Top Button -->
    <button id="goToTop" class="go-to-top" title="Ir arriba">
        <i class="fas fa-arrow-up"></i>
    </button>
</body>
</html>
