<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/colors.css" rel="stylesheet">
    <link href="/css/dashboard.css" rel="stylesheet">
    <style>
        .form-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .form-section h5 {
            color: var(--farmadescaso-primary);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--farmadescaso-primary);
            padding-bottom: 10px;
        }
    </style>

    <%- include('../partials/navbar-styles') %></head>
<body>
    <%- include('../partials/navbar-dashboard') %>
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0">
                <i class="fas fa-<%= isNew ? 'plus' : 'edit' %> me-2"></i>
                <%= isNew ? 'Nuevo Cliente' : 'Editar Cliente #' + (cliente ? (cliente.Id || cliente.id) : '') %>
            </h3>
            <div>
                <% if (!isNew && cliente) { %>
                <a href="/dashboard/clientes/<%= cliente.Id || cliente.id %>" class="btn btn-secondary"><i class="fas fa-eye me-1"></i>Ver</a>
                <% } %>
                <a href="/dashboard/clientes" class="btn btn-outline-secondary">Volver</a>
            </div>
        </div>
        <% if (error) { %>
        <div class="alert alert-danger"><%= error %></div>
        <% } %>

        <!-- Modal para mostrar clientes duplicados -->
        <div class="modal fade" id="modalDuplicados" tabindex="-1" aria-labelledby="modalDuplicadosLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header bg-warning">
                        <h5 class="modal-title" id="modalDuplicadosLabel">
                            <i class="fas fa-exclamation-triangle me-2"></i>Cliente Similar Encontrado
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle me-2"></i>
                            Ya existe un cliente similar en la base de datos. Por favor, revisa los datos antes de continuar.
                        </div>
                        <div id="duplicadosContent">
                            <!-- Los clientes duplicados se mostrarán aquí -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-warning" id="btnVerClienteExistente">
                            <i class="fas fa-eye me-1"></i>Ver Cliente Existente
                        </button>
                        <button type="button" class="btn btn-primary" id="btnContinuarCrear">
                            <i class="fas fa-check me-1"></i>Continuar Creando
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <form method="post" id="formCliente" action="<%= isNew ? '/dashboard/clientes/nuevo' : '/dashboard/clientes/' + (cliente ? (cliente.Id || cliente.id) : '') %>">
            <!-- Sección: Información Básica -->
            <div class="form-section">
                <h5><i class="fas fa-user me-2"></i>Información Básica</h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Nombre / Razón Social <span class="text-danger">*</span></label>
                        <div class="position-relative">
                            <input
                                type="text"
                                name="Nombre_Razon_Social"
                                id="clienteNombreSearchInput"
                                class="form-control"
                                required
                                autocomplete="off"
                                value="<%= cliente ? (cliente.Nombre_Razon_Social || cliente.Nombre || '') : '' %>">
                            <% if (isNew) { %>
                                <div id="clienteNombreDropdown" class="list-group position-absolute w-100 shadow-sm" style="top: 100%; z-index: 1050; max-height: 320px; overflow-y: auto; display: none;"></div>
                            <% } %>
                        </div>
                        <% if (isNew) { %>
                            <small class="text-muted d-block mt-1">
                                <i class="fas fa-search me-1"></i>Escribe al menos 2 caracteres para buscar clientes existentes.
                            </small>
                        <% } %>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Nombre Comercial</label>
                        <input type="text" name="Nombre_Cial" class="form-control" value="<%= cliente ? (cliente.Nombre_Cial || '') : '' %>">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">DNI/CIF</label>
                        <input type="text" name="DNI_CIF" class="form-control" placeholder="Pendiente (dejar vacío)" value="<%= cliente ? (cliente.DNI_CIF || '') : '' %>">
                        <small class="text-muted">Dejar vacío para "Pendiente"</small>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Nº Farmacia</label>
                        <input type="text" name="NumeroFarmacia" class="form-control" value="<%= cliente ? (cliente.NumeroFarmacia || '') : '' %>">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Comercial <span class="text-danger">*</span></label>
                        <% const esAdminView = (typeof esAdmin !== 'undefined' && esAdmin); %>
                        <% const comercialAuthedId = (typeof comercialIdAutenticado !== 'undefined' && comercialIdAutenticado) ? comercialIdAutenticado : null; %>
                        <% const clienteComercialIdHidden = cliente ? (cliente.Id_Cial || cliente.id_Cial || null) : null; %>
                        <% const idCialHidden = clienteComercialIdHidden || comercialAuthedId; %>
                        <% if (!esAdminView) { %>
                            <input type="hidden" name="Id_Cial" value="<%= idCialHidden %>">
                            <input type="text" class="form-control" value="<%= (user && (user.nombre || user.Nombre)) ? (user.nombre || user.Nombre) : 'Comercial' %>" disabled readonly style="background-color: #e9ecef; cursor: not-allowed;">
                            <small class="text-muted"><i class="fas fa-lock me-1"></i>Asignación automática al comercial logueado</small>
                        <% } else { %>
                            <select name="Id_Cial" class="form-select" required>
                                <option value="">— Seleccionar comercial —</option>
                                <% if (typeof comerciales !== 'undefined' && comerciales && comerciales.length > 0) { %>
                                    <% comerciales.forEach(function(comercial) { %>
                                        <% const comercialId = comercial.id || comercial.Id; %>
                                        <% const clienteComercialId = cliente ? (cliente.Id_Cial || cliente.id_Cial) : null; %>
                                        <option value="<%= comercialId %>" <%= (clienteComercialId && String(clienteComercialId) === String(comercialId)) ? 'selected' : '' %>>
                                            <%= comercial.Nombre %> <% if (comercial.Email) { %>(<%= comercial.Email %>)<% } %>
                                        </option>
                                    <% }); %>
                                <% } else { %>
                                    <option value="" disabled>No hay comerciales disponibles</option>
                                <% } %>
                            </select>
                            <small class="text-muted">Selecciona el comercial asignado a este cliente</small>
                        <% } %>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Tipo Cliente</label>
                        <select name="Id_TipoCliente" class="form-select">
                            <option value="">— Seleccionar tipo —</option>
                            <% if (typeof tiposClientes !== 'undefined' && tiposClientes && tiposClientes.length > 0) { %>
                                <% tiposClientes.forEach(function(tipo) { %>
                                    <% const tipoId = tipo.id || tipo.Id; %>
                                    <% const clienteTipoId = cliente ? (cliente.Id_TipoCliente || cliente.id_TipoCliente) : null; %>
                                    <option value="<%= tipoId %>" <%= (clienteTipoId && String(clienteTipoId) === String(tipoId)) ? 'selected' : '' %>>
                                        <%= tipo.Tipo %>
                                    </option>
                                <% }); %>
                            <% } %>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Estado del Cliente <span class="text-danger">*</span></label>
                        <select name="OK_KO" class="form-select" required>
                            <% 
                            // OK_KO debe ser 1 (Activo) o 0 (Inactivo)
                            // También aceptar valores legacy 'OK'/'KO' para compatibilidad
                            const okKoRaw = cliente && (cliente.OK_KO !== undefined && cliente.OK_KO !== null) ? cliente.OK_KO : 1;
                            let estadoActivo = false;
                            
                            if (typeof okKoRaw === 'string') {
                                const okKoUpper = okKoRaw.toUpperCase().trim();
                                estadoActivo = (okKoUpper === 'OK' || okKoUpper === '1' || okKoUpper === 'TRUE');
                            } else if (typeof okKoRaw === 'number') {
                                estadoActivo = (okKoRaw === 1);
                            } else if (typeof okKoRaw === 'boolean') {
                                estadoActivo = okKoRaw;
                            }
                            %>
                            <option value="1" <%= estadoActivo ? 'selected' : '' %>>Activo</option>
                            <option value="0" <%= !estadoActivo ? 'selected' : '' %>>Inactivo</option>
                        </select>
                        <small class="text-muted">El estado debe ser "Activo" (1) o "Inactivo" (0)</small>
                    </div>
                </div>
            </div>

            <!-- Sección: Contacto -->
            <div class="form-section">
                <h5><i class="fas fa-phone me-2"></i>Información de Contacto</h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Email</label>
                        <input type="email" name="Email" class="form-control" value="<%= cliente ? (cliente.Email || '') : '' %>">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Teléfono</label>
                        <input type="text" name="Telefono" class="form-control" value="<%= cliente ? (cliente.Telefono || cliente['Teléfono'] || '') : '' %>">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Móvil</label>
                        <input type="text" name="Movil" class="form-control" value="<%= cliente ? (cliente.Movil || cliente['Móvil'] || '') : '' %>">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Contacto</label>
                        <input type="text" name="NomContacto" class="form-control" value="<%= cliente ? (cliente.NomContacto || '') : '' %>">
                    </div>
                </div>
            </div>

            <!-- Sección: Dirección -->
            <div class="form-section">
                <h5><i class="fas fa-map-marker-alt me-2"></i>Dirección</h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Dirección</label>
                        <input type="text" name="Direccion" class="form-control" value="<%= cliente ? (cliente.Direccion || '') : '' %>">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Población</label>
                        <input type="text" name="Poblacion" class="form-control" value="<%= cliente ? (cliente.Poblacion || '') : '' %>">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Código Postal</label>
                        <input type="text" name="CodigoPostal" class="form-control" value="<%= cliente ? (cliente.CodigoPostal || '') : '' %>">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Provincia</label>
                        <select name="Id_Provincia" class="form-select">
                            <option value="">— Seleccionar provincia —</option>
                            <% if (typeof provincias !== 'undefined' && provincias && provincias.length > 0) { %>
                                <% provincias.forEach(function(provincia) { %>
                                    <% const provinciaId = provincia.id || provincia.Id; %>
                                    <% const clienteProvinciaId = cliente ? (cliente.Id_Provincia || cliente.id_Provincia) : null; %>
                                    <option value="<%= provinciaId %>" <%= (clienteProvinciaId && String(clienteProvinciaId) === String(provinciaId)) ? 'selected' : '' %>>
                                        <%= provincia.Nombre %> (<%= typeof normalizeUTF8 !== 'undefined' ? normalizeUTF8(provincia.Pais || '') : (provincia.Pais || '') %>)
                                    </option>
                                <% }); %>
                            <% } %>
                        </select>
                        <small class="text-muted">La provincia se puede asignar automáticamente al cambiar el código postal</small>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">País</label>
                        <select name="Id_Pais" class="form-select" id="selectPais">
                            <option value="">— Seleccionar país —</option>
                            <% if (typeof paises !== 'undefined' && paises && paises.length > 0) { %>
                                <% 
                                const clientePaisId = cliente ? (cliente.Id_Pais || cliente.id_Pais) : null;
                                // Por defecto España si no hay país asignado
                                let paisPorDefectoId = clientePaisId;
                                if (!paisPorDefectoId) {
                                    const espana = paises.find(p => p.Id_pais === 'ES');
                                    paisPorDefectoId = espana ? espana.id : null;
                                }
                                %>
                                <% paises.forEach(function(pais) { %>
                                    <% const paisId = pais.id || pais.Id; %>
                                    <% const isSelected = (paisPorDefectoId && String(paisPorDefectoId) === String(paisId)) || (!clientePaisId && pais.Id_pais === 'ES'); %>
                                    <option value="<%= paisId %>" <%= isSelected ? 'selected' : '' %>>
                                        <%= typeof normalizeUTF8 !== 'undefined' ? normalizeUTF8(pais.Nombre_pais || '') : (pais.Nombre_pais || '') %> (<%= pais.Id_pais %>)
                                    </option>
                                <% }); %>
                            <% } %>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Código País (legacy)</label>
                        <input type="text" name="CodPais" class="form-control" maxlength="3" value="<%= cliente ? (cliente.CodPais || '') : '' %>" readonly>
                        <small class="text-muted">Campo legacy, se actualiza automáticamente</small>
                    </div>
                </div>
            </div>

            <!-- Sección: Configuración Comercial -->
            <div class="form-section">
                <h5><i class="fas fa-cog me-2"></i>Configuración Comercial</h5>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Idioma</label>
                        <select name="Id_Idioma" class="form-select">
                            <option value="">— Seleccionar idioma —</option>
                            <% if (typeof idiomas !== 'undefined' && idiomas && idiomas.length > 0) { %>
                                <% idiomas.forEach(function(idioma) { %>
                                    <% const idiomaId = idioma.id || idioma.Id; %>
                                    <% const clienteIdiomaId = cliente ? (cliente.Id_Idioma || cliente.id_Idioma) : null; %>
                                    <option value="<%= idiomaId %>" <%= (clienteIdiomaId && String(clienteIdiomaId) === String(idiomaId)) ? 'selected' : '' %>>
                                        <%= idioma.Idioma %>
                                    </option>
                                <% }); %>
                            <% } %>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Moneda</label>
                        <select name="Id_Moneda" class="form-select">
                            <option value="">— Seleccionar moneda —</option>
                            <% if (typeof monedas !== 'undefined' && monedas && monedas.length > 0) { %>
                                <% monedas.forEach(function(moneda) { %>
                                    <% const monedaId = moneda.id || moneda.Id; %>
                                    <% const clienteMonedaId = cliente ? (cliente.Id_Moneda || cliente.id_Moneda) : null; %>
                                    <option value="<%= monedaId %>" <%= (clienteMonedaId && String(clienteMonedaId) === String(monedaId)) ? 'selected' : '' %>>
                                        <%= moneda.Moneda %>
                                    </option>
                                <% }); %>
                            <% } %>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Forma de Pago</label>
                        <select name="Id_FormaPago" class="form-select">
                            <option value="">— Seleccionar forma de pago —</option>
                            <% if (typeof formasPago !== 'undefined' && formasPago && formasPago.length > 0) { %>
                                <% formasPago.forEach(function(formaPago) { %>
                                    <% const formaPagoId = formaPago.id || formaPago.Id; %>
                                    <% const clienteFormaPagoId = cliente ? (cliente.Id_FormaPago || cliente.id_FormaPago) : null; %>
                                    <option value="<%= formaPagoId %>" <%= (clienteFormaPagoId && String(clienteFormaPagoId) === String(formaPagoId)) ? 'selected' : '' %>>
                                        <%= formaPago.FormaPago || formaPago.Nombre || formaPago.formaPago || 'Sin nombre' %>
                                    </option>
                                <% }); %>
                            <% } else { %>
                                <option value="" disabled>No se pudieron cargar las formas de pago</option>
                            <% } %>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Tarifa</label>
                        <% const tarifaSeleccionada = cliente ? (cliente.Tarifa ?? cliente.tarifa ?? 0) : 0; %>
                        <% if (typeof tarifasClientes !== 'undefined' && tarifasClientes && tarifasClientes.length > 0) { %>
                        <select name="Tarifa" class="form-select">
                            <option value="0" <%= String(tarifaSeleccionada) === '0' ? 'selected' : '' %>>PVL (Base)</option>
                            <% tarifasClientes.forEach(function(t) { %>
                                <% const tid = t.Id || t.id; %>
                                <option value="<%= tid %>" <%= String(tarifaSeleccionada) === String(tid) ? 'selected' : '' %>>
                                    <%= t.NombreTarifa %> <%= (t.Activa === 0 || t.Activa === '0') ? '(Inactiva)' : '' %>
                                </option>
                            <% }); %>
                        </select>
                        <small class="text-muted">Tarifa aplicada por defecto a este cliente (si la tarifa termina, se usará la PVL/base)</small>
                        <% } else { %>
                        <input type="number" name="Tarifa" class="form-control" value="<%= tarifaSeleccionada %>">
                        <small class="text-muted">No se pudieron cargar las tarifas; introduzca el ID manualmente (0 = PVL)</small>
                        <% } %>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Dto (%)</label>
                        <input type="number" name="Dto" class="form-control" step="0.01" min="0" max="100" value="<%= cliente && cliente.Dto !== null && cliente.Dto !== undefined ? cliente.Dto : '' %>">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">RE (%)</label>
                        <input type="number" name="RE" class="form-control" step="0.01" min="0" max="100" value="<%= cliente && cliente.RE !== null && cliente.RE !== undefined ? cliente.RE : '' %>">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Cuenta Contable</label>
                        <input type="number" name="CuentaContable" class="form-control" value="<%= cliente ? (cliente.CuentaContable || '') : '' %>">
                    </div>
                </div>
            </div>

            <!-- Sección: Datos Bancarios -->
            <div class="form-section">
                <h5><i class="fas fa-university me-2"></i>Datos Bancarios</h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Banco</label>
                        <input type="text" name="Banco" class="form-control" value="<%= cliente ? (cliente.Banco || '') : '' %>">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Swift</label>
                        <input type="text" name="Swift" class="form-control" value="<%= cliente ? (cliente.Swift || '') : '' %>">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">IBAN</label>
                        <input type="text" name="IBAN" class="form-control" maxlength="34" value="<%= cliente ? (cliente.IBAN || '') : '' %>">
                    </div>
                </div>
            </div>

            <!-- Sección: Información Adicional -->
            <div class="form-section">
                <h5><i class="fas fa-info-circle me-2"></i>Información Adicional</h5>
                <div class="row g-3">
                    <div class="col-md-9">
                        <label class="form-label">Cooperativas</label>
                        <% 
                        const tieneCooperativas = typeof cooperativasCliente !== 'undefined' && cooperativasCliente && Array.isArray(cooperativasCliente) && cooperativasCliente.length > 0;
                        const textoCooperativas = tieneCooperativas ? cooperativasCliente.map(c => (c.Nombre || c.nombre || 'Sin nombre')).join(', ') : 'Sin Asignar';
                        %>
                        <input type="text" class="form-control" value="<%= textoCooperativas %>" readonly>
                        <small class="text-muted">Las cooperativas se asignan automáticamente desde la tabla clientes_cooperativas</small>
                        <% if (tieneCooperativas) { %>
                        <div class="mt-2">
                            <% cooperativasCliente.forEach(function(coop) { %>
                            <span class="badge bg-info me-1 mb-1">
                                <%= coop.Nombre || coop.nombre || 'Sin nombre' %> 
                                <% if (coop.NumAsociado && coop.NumAsociado.trim() !== '') { %>
                                <small>(<%= coop.NumAsociado %>)</small>
                                <% } %>
                            </span>
                            <% }); %>
                        </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <div class="mt-4 d-flex gap-2">
                <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i><%= isNew ? 'Crear Cliente' : 'Guardar Cambios' %></button>
                <% if (!isNew && cliente) { %>
                <a href="/dashboard/clientes/<%= cliente.Id || cliente.id %>" class="btn btn-outline-info"><i class="fas fa-eye me-1"></i>Ver Detalle</a>
                <% } %>
                <a href="/dashboard/clientes" class="btn btn-outline-secondary">Cancelar</a>
            </div>
        </form>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/go-to-top.js"></script>

    <% if (isNew) { %>
    <script>
        // Autocomplete (búsqueda inteligente) en Nombre/Razón Social
        (function() {
            const input = document.getElementById('clienteNombreSearchInput');
            const dropdown = document.getElementById('clienteNombreDropdown');
            if (!input || !dropdown) return;

            let t = null;
            let lastQuery = '';

            const hide = () => { dropdown.style.display = 'none'; dropdown.innerHTML = ''; };
            const show = () => { dropdown.style.display = 'block'; };

            const escapeHtml = (s) => String(s ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');

            async function fetchClientes(q) {
                const url = `/api/clientes/buscar?q=${encodeURIComponent(q)}&estado=activos&limit=20`;
                const res = await fetch(url, { credentials: 'include' });
                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    const details = data && (data.details || data.error) ? (data.details || data.error) : `HTTP ${res.status}`;
                    throw new Error(details);
                }
                return (data.clientes || []);
            }

            function render(clientes) {
                if (!Array.isArray(clientes) || clientes.length === 0) {
                    dropdown.innerHTML = `<div class="list-group-item text-muted small">No se encontraron clientes</div>`;
                    show();
                    return;
                }

                dropdown.innerHTML = clientes.map(c => {
                    const id = c.Id ?? c.id;
                    const nombre = c.Nombre_Razon_Social || c.Nombre || '-';
                    const dni = c.DNI_CIF || '';
                    const pobl = c.Poblacion || '';
                    const cp = c.CodigoPostal || '';
                    const email = c.Email || '';
                    const tel = c.Telefono || c.Movil || '';
                    const meta = [dni, pobl, cp].filter(Boolean).join(' · ');
                    const meta2 = [email, tel].filter(Boolean).join(' · ');
                    return `
                        <button type="button" class="list-group-item list-group-item-action" data-id="${escapeHtml(id)}">
                            <div class="fw-semibold">${escapeHtml(nombre)}</div>
                            ${meta ? `<div class="text-muted small">${escapeHtml(meta)}</div>` : ''}
                            ${meta2 ? `<div class="text-muted small">${escapeHtml(meta2)}</div>` : ''}
                            <div class="small mt-1"><span class="badge bg-secondary">ID ${escapeHtml(id)}</span></div>
                        </button>
                    `;
                }).join('');
                show();

                dropdown.querySelectorAll('button[data-id]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.getAttribute('data-id');
                        if (id) window.location.href = `/dashboard/clientes/${encodeURIComponent(id)}`;
                    });
                });
            }

            input.addEventListener('input', () => {
                const q = String(input.value || '').trim();
                if (q.length < 2) {
                    lastQuery = q;
                    hide();
                    return;
                }
                if (q === lastQuery) return;
                lastQuery = q;
                clearTimeout(t);
                t = setTimeout(async () => {
                    dropdown.innerHTML = `<div class="list-group-item text-muted small"><i class="fas fa-spinner fa-spin me-2"></i>Buscando...</div>`;
                    show();
                    try {
                        const clientes = await fetchClientes(q);
                        render(clientes);
                    } catch (e) {
                        dropdown.innerHTML = `<div class="list-group-item text-danger small">Error buscando clientes: ${escapeHtml(e.message || 'desconocido')}</div>`;
                        show();
                    }
                }, 250);
            });

            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target) && e.target !== input) hide();
            });
        })();

        // Verificar duplicados antes de crear cliente
        document.getElementById('formCliente').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const form = this;
            const formData = new FormData(form);
            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            // Deshabilitar botón mientras se verifica
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Verificando...';
            
            try {
                // Crear objeto con los datos del formulario
                const data = {};
                formData.forEach((value, key) => {
                    data[key] = value;
                });
                
                // Hacer petición AJAX para verificar duplicados
                const response = await fetch('/dashboard/clientes/verificar-duplicado', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.duplicado && result.clientes && result.clientes.length > 0) {
                    // Hay duplicados, mostrar modal
                    mostrarDuplicados(result.clientes);
                    
                    // Rehabilitar botón
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                } else {
                    // No hay duplicados, enviar formulario normalmente
                    form.submit();
                }
            } catch (error) {
                console.error('Error verificando duplicados:', error);
                // En caso de error, continuar con el envío normal
                form.submit();
            }
        });
        
        let clienteDuplicadoId = null;
        
        function mostrarDuplicados(clientes) {
            const content = document.getElementById('duplicadosContent');
            content.innerHTML = '';
            
            clientes.forEach((cliente, index) => {
                const clienteDiv = document.createElement('div');
                clienteDiv.className = 'card mb-3';
                clienteDiv.innerHTML = `
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-user me-2"></i>Cliente #${cliente.id}
                            ${cliente.coincidencias && cliente.coincidencias.length > 0 ? 
                                `<span class="badge bg-warning ms-2">${cliente.coincidencias.map(c => c.campo).join(', ')}</span>` : ''}
                        </h6>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <strong>Nombre/Razón Social:</strong><br>
                                <span>${cliente.nombre || 'N/A'}</span>
                            </div>
                            ${cliente.dni_cif ? `
                            <div class="col-md-6">
                                <strong>DNI/CIF:</strong><br>
                                <span>${cliente.dni_cif}</span>
                            </div>
                            ` : ''}
                            ${cliente.direccion ? `
                            <div class="col-md-12">
                                <strong>Dirección:</strong><br>
                                <span>${cliente.direccion}</span>
                            </div>
                            ` : ''}
                            <div class="col-md-4">
                                ${cliente.poblacion ? `<strong>Población:</strong><br><span>${cliente.poblacion}</span>` : ''}
                            </div>
                            <div class="col-md-4">
                                ${cliente.provincia ? `<strong>Provincia:</strong><br><span>${cliente.provincia}</span>` : ''}
                            </div>
                            <div class="col-md-4">
                                ${cliente.codigo_postal ? `<strong>CP:</strong><br><span>${cliente.codigo_postal}</span>` : ''}
                            </div>
                            <div class="col-md-6">
                                ${cliente.telefono ? `<strong>Teléfono:</strong><br><span>${cliente.telefono}</span>` : ''}
                            </div>
                            <div class="col-md-6">
                                ${cliente.email ? `<strong>Email:</strong><br><span>${cliente.email}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                content.appendChild(clienteDiv);
                
                if (index === 0) {
                    clienteDuplicadoId = cliente.id;
                }
            });
            
            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalDuplicados'));
            modal.show();
        }
        
        // Botón para ver cliente existente
        document.getElementById('btnVerClienteExistente').addEventListener('click', function() {
            if (clienteDuplicadoId) {
                window.location.href = `/dashboard/clientes/${clienteDuplicadoId}`;
            }
        });
        
        // Botón para continuar creando
        document.getElementById('btnContinuarCrear').addEventListener('click', function() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalDuplicados'));
            modal.hide();
            
            // Enviar formulario sin verificación AJAX (añadir parámetro especial)
            const form = document.getElementById('formCliente');
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'forzar_creacion';
            hiddenInput.value = 'true';
            form.appendChild(hiddenInput);
            form.submit();
        });
    </script>
    <% } %>

    <!-- Go to Top Button -->
    <button id="goToTop" class="go-to-top" title="Ir arriba">
        <i class="fas fa-arrow-up"></i>
    </button>
</body>
</html>
