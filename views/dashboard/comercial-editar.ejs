<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/colors.css" rel="stylesheet">
    <link href="/css/dashboard.css" rel="stylesheet">

    <%- include('../partials/navbar-styles') %></head>
<body>
    <%- include('../partials/navbar-dashboard') %>

    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas <%= isNew ? 'fa-plus' : 'fa-edit' %> me-2"></i>
                            <%= isNew ? 'Nuevo Comercial' : `Editar Comercial #${comercial.id || comercial.Id}` %>
                        </h5>
                    </div>
                    <div class="card-body">
                        <% if (error) { %>
                        <div class="alert alert-danger"><%= error %></div>
                        <% } %>
                        <% if (typeof req !== 'undefined' && req.query && req.query.error) { %>
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <strong>Error:</strong> <%= req.query.error %>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        <% } %>

                        <% const formAction = isNew ? '/dashboard/comerciales' : `/dashboard/comerciales/${comercial.id || comercial.Id}`; %>
                        <form method="post" action="<%= formAction %>">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">Nombre <span class="text-danger">*</span></label>
                                    <input type="text" name="Nombre" class="form-control" value="<%= comercial ? (comercial.Nombre || comercial.nombre || '') : '' %>" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">Email <span class="text-danger">*</span></label>
                                    <input type="email" name="Email" class="form-control" value="<%= comercial ? (comercial.Email || comercial.email || '') : '' %>" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">DNI</label>
                                    <input type="text" name="DNI" class="form-control" value="<%= comercial ? (comercial.DNI || comercial.dni || '') : '' %>">
                                    <small class="text-muted">Si no se proporciona password, se usará el DNI como password por defecto</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">Password</label>
                                    <input type="password" name="Password" class="form-control" value="" autocomplete="<%= isNew ? 'new-password' : 'new-password' %>" placeholder="<%= isNew ? 'Dejar vacío para usar DNI' : 'Dejar vacío para no cambiar' %>">
                                    <small class="text-muted"><%= isNew ? 'Si se deja vacío, se usará el DNI como password' : 'Dejar vacío para mantener la contraseña actual' %></small>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Rol</label>
                                <select name="Roll" class="form-select">
                                    <option value='["Comercial"]' <%= comercial && comercial.Roll && (comercial.Roll.includes('Comercial') || (typeof comercial.Roll === 'string' && comercial.Roll.includes('Comercial'))) ? 'selected' : '' %>>Comercial</option>
                                    <option value='["Administrador"]' <%= comercial && comercial.Roll && (comercial.Roll.includes('Administrador') || comercial.Roll.includes('administrador') || (typeof comercial.Roll === 'string' && comercial.Roll.includes('Administrador'))) ? 'selected' : '' %>>Administrador</option>
                                </select>
                                <small class="text-muted">Selecciona el rol del comercial en el sistema</small>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">Móvil</label>
                                    <input type="text" name="Movil" class="form-control" value="<%= comercial ? (comercial.Movil || comercial.movil || '') : '' %>">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">Dirección</label>
                                    <input type="text" name="Direccion" class="form-control" value="<%= comercial ? (comercial.Direccion || comercial.direccion || '') : '' %>">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-semibold">Código Postal</label>
                                    <input type="text" name="CodigoPostal" id="codigoPostalComercial" class="form-control" value="<%= comercial ? (comercial.CodigoPostal || comercial.codigoPostal || '') : '' %>">
                                    <small class="text-muted">La provincia se asignará automáticamente</small>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-semibold">Población</label>
                                    <input type="text" name="Poblacion" class="form-control" value="<%= comercial ? (comercial.Poblacion || comercial.poblacion || '') : '' %>">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-semibold">Provincia</label>
                                    <select name="Id_Provincia" id="provinciaComercial" class="form-select">
                                        <option value="">— Seleccionar provincia —</option>
                                        <% if (typeof provincias !== 'undefined' && provincias && provincias.length > 0) { %>
                                            <% provincias.forEach(function(provincia) { %>
                                                <% const provinciaId = provincia.id || provincia.Id; %>
                                                <% const comercialProvinciaId = comercial ? (comercial.Id_Provincia || comercial.id_Provincia) : null; %>
                                                <option value="<%= provinciaId %>" <%= (comercialProvinciaId && String(comercialProvinciaId) === String(provinciaId)) ? 'selected' : '' %>>
                                                    <%= typeof normalizeUTF8 !== 'undefined' ? normalizeUTF8(provincia.Nombre || '') : (provincia.Nombre || '') %> (<%= typeof normalizeUTF8 !== 'undefined' ? normalizeUTF8(provincia.Pais || '') : (provincia.Pais || '') %>)
                                                </option>
                                            <% }); %>
                                        <% } %>
                                    </select>
                                    <small class="text-muted">Se establece automáticamente por código postal</small>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end gap-2">
                                <a href="/dashboard/comerciales" class="btn btn-secondary">Cancelar</a>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save me-1"></i>Guardar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">    </script>
    <script src="/js/go-to-top.js"></script>

    <script>
        // Establecer provincia automáticamente por código postal
        const codigoPostalInput = document.getElementById('codigoPostalComercial');
        const provinciaSelect = document.getElementById('provinciaComercial');
        
        if (codigoPostalInput && provinciaSelect) {
            codigoPostalInput.addEventListener('blur', async function() {
                const codigoPostal = this.value.trim();
                
                if (!codigoPostal || codigoPostal.length < 2) {
                    return;
                }
                
                try {
                    // Obtener provincias
                    const provinciasResponse = await fetch('/api/provincias?pais=ES');
                    const provinciasData = await provinciasResponse.json();
                    
                    if (!provinciasData.success || !provinciasData.provincias) {
                        console.warn('No se pudieron obtener las provincias');
                        return;
                    }
                    
                    // Función para obtener provincia por código postal (España)
                    function obtenerProvinciaPorCP(cp) {
                        const cpLimpio = String(cp).trim().replace(/[^0-9]/g, '');
                        if (cpLimpio.length < 2) return null;
                        
                        const prefijo = cpLimpio.substring(0, 2);
                        const provinciaId = parseInt(prefijo);
                        
                        // Validar que el ID esté en el rango válido (1-52)
                        if (provinciaId >= 1 && provinciaId <= 52) {
                            return provinciaId;
                        }
                        
                        return null;
                    }
                    
                    const provinciaId = obtenerProvinciaPorCP(codigoPostal);
                    
                    if (provinciaId) {
                        // Buscar la provincia en el select
                        const provinciaOption = Array.from(provinciaSelect.options).find(
                            option => parseInt(option.value) === provinciaId
                        );
                        
                        if (provinciaOption) {
                            provinciaSelect.value = provinciaId;
                            console.log(`✅ Provincia ${provinciaId} asignada automáticamente por CP ${codigoPostal}`);
                        } else {
                            console.warn(`⚠️ Provincia ${provinciaId} no encontrada en el select`);
                        }
                    } else {
                        console.warn(`⚠️ No se pudo determinar la provincia para el CP ${codigoPostal}`);
                    }
                } catch (error) {
                    console.error('Error estableciendo provincia automáticamente:', error);
                }
            });
        }
    </script>

    <!-- Go to Top Button -->
    <button id="goToTop" class="go-to-top" title="Ir arriba">
        <i class="fas fa-arrow-up"></i>
    </button>
</body>
</html>

