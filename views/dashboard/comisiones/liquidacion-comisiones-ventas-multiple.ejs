<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="/css/colors.css" rel="stylesheet">
  <link href="/css/dashboard.css" rel="stylesheet">
  <%- include('../../partials/navbar-styles') %>
  <style>
    @media print {
      .no-print { display: none !important; }
      body { background: #fff !important; }
      /* A4 + márgenes similares a la liquidación individual */
      @page { size: A4; margin: 10mm; }
      .card { border: none !important; box-shadow: none !important; }
      .container-fluid { padding: 0 !important; }
      .main-content { padding: 0 !important; }
      .table { font-size: 11px; }
      thead { display: table-header-group; }
      tfoot { display: table-footer-group; }
      a[href]:after { content: "" !important; }

      /* Reducir espacios entre bloques en impresión */
      .mb-3 { margin-bottom: 10px !important; }
      .pb-2 { padding-bottom: 6px !important; }
      .pt-3 { padding-top: 6px !important; }

      /* Cabecera de impresión (compacta) */
      .print-only { display: block !important; }
      .print-header { display: block !important; position: relative; padding: 0 0 6px 0; margin: 0 0 8px 0; }
      .print-header h1 { font-size: 16px !important; margin: 0; }
      .print-header .meta { font-size: 11px; color: #444; }
      .doc-logo-inline { display: block !important; position: absolute; top: 0; left: 50%; transform: translateX(-50%); height: 22px; width: auto; opacity: .28; pointer-events: none; }

      /* En impresión, usar tabla compacta de totales */
      .totals-cards { display: none !important; }
      .totals-print { page-break-inside: avoid; break-inside: avoid; }
    }
    /* En pantalla no mostrar los elementos exclusivos de impresión */
    .print-only { display: none; }
    .doc-logo-inline { display: none; }
    .table thead th { white-space: nowrap; }
  </style>
</head>
<body>
  <%- include('../../partials/navbar-dashboard') %>

  <div class="container-fluid">
    <div class="row">
      <main class="col-12 px-md-4 main-content">
        <!-- Cabecera SOLO para impresión -->
        <div class="print-only print-header">
          <img class="doc-logo-inline" src="/images/logos/farmadescanso-gemavip.jpg" alt="Farmadescanso / Gemavip">
          <h1>Liquidación Comisiones (múltiple)</h1>
          <div class="meta">
            Comercial: <strong><%= comercial.nombre %></strong>
            · Meses: <strong><%= (comisiones || []).length %></strong>
            · Fecha: <strong><%= new Date().toLocaleDateString('es-ES') %></strong>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
          <div>
            <h1 class="h3 mb-1">
              <i class="fas fa-file-invoice-dollar me-2 text-primary"></i>
              Liquidación múltiple (Comisiones de Ventas)
            </h1>
            <div class="text-muted">
              Comercial: <strong><%= comercial.nombre %></strong>
              · Meses: <strong><%= (comisiones || []).length %></strong>
            </div>
          </div>
          <div class="no-print d-flex gap-2">
            <a class="btn btn-outline-secondary" href="/dashboard/comisiones/comisiones?comercial_id=<%= comercial.id %>">
              <i class="fas fa-arrow-left me-1"></i>Volver
            </a>
            <button class="btn btn-primary" onclick="window.print()">
              <i class="fas fa-print me-1"></i>Imprimir / Guardar PDF
            </button>
          </div>
        </div>

        <div class="row g-3 mb-3 totals-cards">
          <div class="col-md-4">
            <div class="card border-info">
              <div class="card-body text-center">
                <div class="text-muted">Total base imponible (ventas)</div>
                <div class="h4 text-info mb-0">
                  € <%= Number(totales.total_base || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-primary">
              <div class="card-body text-center">
                <div class="text-muted">Total comisión ventas</div>
                <div class="h4 text-primary mb-0 fw-bold">
                  € <%= Number(totales.total_comision_ventas || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-warning">
              <div class="card-body text-center">
                <div class="text-muted">Total fijo (según configuración por marca)</div>
                <div class="h4 text-warning mb-0">
                  € <%= Number(totales.total_fijo || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Totales SOLO para impresión (horizontal, compacto) -->
        <div class="print-only totals-print mb-3">
          <table class="table table-sm table-bordered align-middle mb-0" style="width: 100%;">
            <tbody>
              <tr>
                <th style="width: 34%;">Base imponible (ventas)</th>
                <td class="text-end" style="width: 33%;">
                  € <%= Number(totales.total_base || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
                </td>
                <th style="width: 33%;">Comisión ventas</th>
                <td class="text-end">
                  € <%= Number(totales.total_comision_ventas || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
                </td>
              </tr>
              <tr>
                <th>Fijo mensual (por marca)</th>
                <td class="text-end">
                  € <%= Number(totales.total_fijo || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
                </td>
                <th>% efectivo (ventas)</th>
                <td class="text-end">
                  <%= (Number(totales.total_base || 0) > 0 ? (Number(totales.total_comision_ventas || 0) / Number(totales.total_base || 1)) * 100 : 0).toFixed(2) %>%
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="card mb-3">
          <div class="card-header bg-light">
            <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Meses incluidos</h5>
          </div>
          <div class="card-body">
            <div class="d-flex flex-wrap gap-2">
              <% (comisiones || []).forEach(c => { %>
                <span class="badge bg-secondary">
                  <%= ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][Number(c.mes || 1)-1] %>/<%= c.año %>
                </span>
              <% }) %>
            </div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header bg-light">
            <h5 class="mb-0">
              <i class="fas fa-table me-2"></i>Ventas por pedido y marca (todos los meses)
              <span class="badge bg-primary ms-2"><%= (filas || []).length %> fila(s)</span>
            </h5>
          </div>
          <div class="card-body">
            <% if (!filas || filas.length === 0) { %>
              <div class="alert alert-info mb-0">No hay líneas de comisión de ventas guardadas para los meses seleccionados.</div>
            <% } else { %>
              <div class="table-responsive">
                <table class="table table-sm table-striped table-hover align-middle">
                  <caption class="text-muted">Detalle agrupado por pedido y marca. Incluye columna Mes/Año.</caption>
                  <thead>
                    <tr>
                      <th scope="col">Mes/Año</th>
                      <th scope="col">Pedido</th>
                      <th scope="col">Fecha</th>
                      <th scope="col">Cliente</th>
                      <th scope="col">Marca</th>
                      <th scope="col" class="text-end">Base imponible</th>
                      <th scope="col" class="text-end">% efectivo</th>
                      <th scope="col" class="text-end">Comisión ventas</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% filas.forEach(r => { %>
                      <tr>
                        <td>
                          <%= ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][Number(r.mes || 1)-1] %>/<%= r.año %>
                        </td>
                        <td><%= r.pedido_numero || 'N/A' %></td>
                        <td><%= r.pedido_fecha ? new Date(r.pedido_fecha).toLocaleDateString('es-ES') : '-' %></td>
                        <td><%= r.cliente_nombre || '-' %></td>
                        <td><%= r.marca_nombre || '-' %></td>
                        <td class="text-end">€ <%= Number(r.base_venta || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                        <td class="text-end"><%= Number(r.pct_efectivo || 0).toFixed(2) %>%</td>
                        <td class="text-end fw-bold">€ <%= Number(r.comision_ventas || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                      </tr>
                    <% }) %>
                  </tbody>
                  <tfoot>
                    <tr class="table-light">
                      <th scope="row" colspan="5" class="text-end">Totales</th>
                      <th class="text-end">€ <%= Number(totales.total_base || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></th>
                      <th class="text-end"><%= (Number(totales.total_base || 0) > 0 ? (Number(totales.total_comision_ventas || 0) / Number(totales.total_base || 1)) * 100 : 0).toFixed(2) %>%</th>
                      <th class="text-end fw-bold">€ <%= Number(totales.total_comision_ventas || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></th>
                    </tr>
                  </tfoot>
                </table>
              </div>
            <% } %>
          </div>
        </div>

        <div class="card">
          <div class="card-header bg-light">
            <h5 class="mb-0"><i class="fas fa-coins me-2"></i>Fijo mensual por marca (por mes)</h5>
          </div>
          <div class="card-body">
            <% if (!fijosPorComision || fijosPorComision.length === 0) { %>
              <div class="alert alert-secondary mb-0">No hay fijos mensuales configurados para los meses seleccionados.</div>
            <% } else { %>
              <% fijosPorComision.forEach(b => { %>
                <div class="mb-3">
                  <div class="d-flex justify-content-between align-items-end">
                    <div class="fw-semibold">
                      <%= ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][Number(b.mes || 1)-1] %>/<%= b.año %>
                    </div>
                    <div class="fw-bold">
                      Total fijo: € <%= Number(b.total || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
                    </div>
                  </div>
                  <% if (!b.items || b.items.length === 0) { %>
                    <div class="text-muted small">Sin fijo configurado por marca en este mes.</div>
                  <% } else { %>
                    <div class="table-responsive">
                      <table class="table table-sm table-striped align-middle mb-0">
                        <thead>
                          <tr>
                            <th>Marca</th>
                            <th class="text-end">Importe</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% b.items.forEach(it => { %>
                            <tr>
                              <td><%= it.marca_nombre %></td>
                              <td class="text-end fw-bold">€ <%= Number(it.importe || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                            </tr>
                          <% }) %>
                        </tbody>
                      </table>
                    </div>
                  <% } %>
                </div>
              <% }) %>
            <% } %>
          </div>
        </div>

      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

