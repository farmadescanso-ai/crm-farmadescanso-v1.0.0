<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="/css/colors.css" rel="stylesheet">
  <link href="/css/dashboard.css" rel="stylesheet">
  <%- include('../../partials/navbar-styles') %>
  <style>
    @media print {
      .no-print { display: none !important; }
      nav, .navbar, .sidebar, .main-header { display: none !important; }
      body { background: #fff !important; }
      .card { border: none !important; box-shadow: none !important; }
      .table { font-size: 12px; }
      a[href]:after { content: "" !important; }
    }
    .table thead th { white-space: nowrap; }
    .badge-pill { border-radius: 999px; }
    .importe-pagado { color: #198754 !important; } /* bootstrap success */
    .importe-pendiente { color: #6c757d !important; } /* bootstrap secondary */
    .liquidacion-completa { border-color: #198754 !important; }
    .liquidacion-parcial { border-color: #fd7e14 !important; } /* bootstrap orange */
    .doc-box { border: 1px solid #dee2e6; border-radius: .5rem; padding: 1rem; background: #fff; }
    .doc-title { letter-spacing: .04em; }
    .doc-meta dt { font-weight: 600; color: #6c757d; }
    .doc-meta dd { margin-bottom: .25rem; }
    .firma-linea { border-top: 1px solid #adb5bd; margin-top: 2.25rem; padding-top: .5rem; }
  </style>
</head>
<body>
  <div class="no-print">
    <%- include('../../partials/navbar-dashboard') %>
  </div>

  <div class="container-fluid">
    <div class="row">
      <main class="col-12 px-md-4 main-content">
        <div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom no-print">
          <div>
            <h1 class="h4 mb-0"><i class="fas fa-file-invoice-dollar me-2 text-primary"></i>Vista previa — Liquidación</h1>
            <div class="text-muted small">Formato “albarán” (imprimible).</div>
          </div>
          <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" href="/dashboard/comisiones/comisiones/<%= comision.id %>">
              <i class="fas fa-arrow-left me-1"></i>Volver
            </a>
            <button class="btn btn-primary" onclick="window.print()">
              <i class="fas fa-print me-1"></i>Imprimir / Guardar PDF
            </button>
          </div>
        </div>

        <%
          const hasConceptCols = ('fecha_pago_ventas' in comision) || ('fecha_pago_fijo' in comision);
          const ventasImporte = (Number(comision.comision_ventas || 0) > 0) ? Number(comision.comision_ventas || 0) : Number(comision.comision_ventas_detalle || 0);
          const fijoImporte = Number(comision.fijo_mensual || 0);
          const ventasPagadas = hasConceptCols ? (!!comision.fecha_pago_ventas || ventasImporte === 0) : (comision.estado === 'Pagado' || comision.estado === 'Pagada');
          const fijoPagado = hasConceptCols ? (!!comision.fecha_pago_fijo || fijoImporte === 0) : (comision.estado === 'Pagado' || comision.estado === 'Pagada');
          const liquidacionCompleta = ventasPagadas && fijoPagado;
          const liquidacionParcial = !liquidacionCompleta && (ventasPagadas || fijoPagado);
          const docNumero = `LC-${comision.id}-${String(comision.año)}${String(comision.mes).padStart(2,'0')}-${String(comision.comercial_id || '').padStart(2,'0')}`;
          const fechaEmision = new Date().toLocaleDateString('es-ES');
        %>

        <!-- CABECERA TIPO ALBARÁN -->
        <div class="doc-box mb-3">
          <div class="row g-3 align-items-start">
            <div class="col-lg-6">
              <div class="d-flex align-items-start gap-3">
                <div style="width:48px;height:48px;border-radius:10px;background:#e7f1ff;display:flex;align-items:center;justify-content:center;">
                  <i class="fas fa-file-signature text-primary"></i>
                </div>
                <div>
                  <div class="text-uppercase fw-bold doc-title">Liquidación de Comisiones</div>
                  <div class="text-muted">Documento justificativo para revisión y emisión de factura por el comercial.</div>
                  <div class="mt-2">
                    <% if (liquidacionCompleta) { %>
                      <span class="badge bg-success">LIQUIDADA</span>
                    <% } else if (liquidacionParcial) { %>
                      <span class="badge bg-warning text-dark">PARCIAL</span>
                    <% } else { %>
                      <span class="badge bg-secondary">PENDIENTE</span>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <dl class="row mb-0 doc-meta">
                <dt class="col-5">Nº Documento</dt>
                <dd class="col-7 fw-semibold"><%= docNumero %></dd>
                <dt class="col-5">Fecha emisión</dt>
                <dd class="col-7"><%= fechaEmision %></dd>
                <dt class="col-5">Comercial</dt>
                <dd class="col-7"><%= comision.comercial_nombre || '-' %> (ID <%= comision.comercial_id %>)</dd>
                <dt class="col-5">Periodo</dt>
                <dd class="col-7">
                  <%= ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][Number(comision.mes || 1) - 1] %>/<%= comision.año %>
                </dd>
              </dl>
            </div>
          </div>
        </div>

        <!-- RESUMEN IMPORTES -->
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <div class="card border-info">
              <div class="card-body text-center">
                <div class="text-muted">Base imponible (ventas)</div>
                <div class="h4 text-info mb-0">
                  € <%= Number(totales.total_venta || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-primary">
              <div class="card-body text-center">
                <div class="text-muted">Comisión ventas</div>
                <div class="h4 mb-0 fw-bold <%= ventasPagadas ? 'text-success' : 'text-primary' %>">
                  € <%= Number(totales.total_comision_ventas || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
                </div>
                <div class="small text-muted mt-1">Estado: <%= ventasPagadas ? 'Pagado' : 'Pendiente' %></div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-warning">
              <div class="card-body text-center">
                <div class="text-muted">Fijo mensual</div>
                <div class="h4 mb-0 fw-bold <%= fijoPagado ? 'text-success' : 'text-warning' %>">
                  € <%= Number(totales.total_fijo_marca || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
                </div>
                <div class="small text-muted mt-1">Estado: <%= fijoPagado ? 'Pagado' : 'Pendiente' %></div>
              </div>
            </div>
          </div>
        </div>

        <div class="card mb-3 no-print">
          <div class="card-body">
            <div class="row g-3 align-items-start">
              <div class="col-lg-7">
                <p class="mb-0 text-muted">
                  Este albarán de liquidación muestra el desglose de <strong>comisiones de ventas</strong> por marca y el <strong>fijo mensual</strong>.
                  Importes mostrados <strong>sin IVA</strong>. La factura la emitirá el comercial según su régimen fiscal.
                </p>
              </div>
              <div class="col-lg-5">
                <div class="p-2 border rounded bg-light">
                  <div class="fw-semibold mb-2"><i class="fas fa-receipt me-2"></i>Pagos (por concepto)</div>
                  <div class="d-flex flex-wrap gap-2 align-items-center">
                    <div>
                      <div class="small text-muted">Ventas</div>
                      <span class="badge <%= ventasPagadas ? 'bg-success' : 'bg-secondary' %> badge-pill">
                        <%= ventasPagadas ? ('Pagado' + (comision.fecha_pago_ventas ? ' · ' + comision.fecha_pago_ventas : '')) : 'Pendiente' %>
                      </span>
                    </div>
                    <div>
                      <div class="small text-muted">Fijo</div>
                      <span class="badge <%= fijoPagado ? 'bg-success' : 'bg-secondary' %> badge-pill">
                        <%= fijoPagado ? ('Pagado' + (comision.fecha_pago_fijo ? ' · ' + comision.fecha_pago_fijo : '')) : 'Pendiente' %>
                      </span>
                    </div>
                    <% if (esAdmin) { %>
                      <div class="ms-auto d-flex gap-2">
                        <input type="date" class="form-control form-control-sm" id="fechaPagoConcepto" value="<%= new Date().toISOString().split('T')[0] %>" aria-label="Fecha de pago">
                        <button class="btn btn-sm btn-outline-success" onclick="pagarConcepto('ventas')">
                          Pagar ventas
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="pagarConcepto('fijo')">
                          Pagar fijo
                        </button>
                      </div>
                    <% } %>
                  </div>
                  <div class="small text-muted mt-2">
                    Nota: si aún no se ha aplicado el ALTER TABLE, el sistema guardará el pago como “ambos” (modo compatibilidad).
                  </div>
                  <div class="small mt-2">
                    <span class="me-3"><span class="fw-bold importe-pagado">Pagado</span></span>
                    <span><span class="fw-bold importe-pendiente">Pendiente</span></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header bg-light">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="fas fa-layer-group me-2"></i>Ventas separadas por marca
                <span class="badge bg-primary ms-2"><%= ((ventasPorMarca || []).length || 0) %> marca(s)</span>
              </h5>
              <% if (ventasPorMarca && ventasPorMarca.length > 1) { %>
                <div class="small text-muted">Acceso rápido:</div>
              <% } %>
            </div>
            <% if (ventasPorMarca && ventasPorMarca.length > 1) { %>
              <div class="mt-2 d-flex flex-wrap gap-2">
                <% ventasPorMarca.forEach((g, idx) => { %>
                  <a class="btn btn-sm btn-outline-secondary" href="#marca-<%= idx %>">
                    <%= g.marca_nombre %>
                  </a>
                <% }) %>
              </div>
            <% } %>
          </div>
          <div class="card-body">
            <% if ((!ventasPorMarca || ventasPorMarca.length === 0) && (!ventasPedidoMarca || ventasPedidoMarca.length === 0)) { %>
              <div class="alert alert-info mb-0">
                No hay líneas de <strong>comisión de ventas</strong> guardadas para esta comisión.
              </div>
            <% } else { %>
              <% const grupos = (ventasPorMarca && ventasPorMarca.length > 0) ? ventasPorMarca : [{ marca_nombre: 'TODAS', filas: ventasPedidoMarca || [], subtotal_base: totales.total_venta || 0, subtotal_comision: totales.total_comision_ventas || 0, pct_efectivo: (Number(totales.total_venta||0)>0 ? (Number(totales.total_comision_ventas||0)/Number(totales.total_venta||1))*100 : 0) }]; %>
              <% grupos.forEach((g, idx) => { %>
                <div class="mb-4" id="marca-<%= idx %>">
                  <div class="d-flex justify-content-between align-items-end mb-2">
                    <div>
                      <div class="fw-bold">
                        <i class="fas fa-tag me-2 text-secondary"></i><%= g.marca_nombre %>
                      </div>
                      <div class="text-muted small">
                        Subtotal base: € <%= Number(g.subtotal_base || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
                        · Subtotal comisión: <span class="<%= ventasPagadas ? 'importe-pagado' : 'importe-pendiente' %> fw-bold">€ <%= Number(g.subtotal_comision || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
                        · % efectivo: <%= Number(g.pct_efectivo || 0).toFixed(2) %>%
                      </div>
                    </div>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-sm table-striped table-hover align-middle">
                      <caption class="text-muted">Detalle de ventas comisionables para la marca <%= g.marca_nombre %>.</caption>
                      <thead>
                        <tr>
                          <th scope="col">Pedido</th>
                          <th scope="col">Fecha</th>
                          <th scope="col">Cliente</th>
                          <th scope="col" class="text-end">Base imponible</th>
                          <th scope="col" class="text-end">% efectivo</th>
                          <th scope="col" class="text-end">Comisión ventas</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% (g.filas || []).forEach(r => { %>
                          <tr>
                            <td><%= r.pedido_numero || r.pedido_id || 'N/A' %></td>
                            <td><%= r.pedido_fecha ? new Date(r.pedido_fecha).toLocaleDateString('es-ES') : '-' %></td>
                            <td><%= r.cliente_nombre || '-' %></td>
                            <td class="text-end">€ <%= Number(r.base_venta || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                            <td class="text-end"><%= Number(r.pct_efectivo || 0).toFixed(2) %>%</td>
                            <td class="text-end fw-bold <%= ventasPagadas ? 'importe-pagado' : 'importe-pendiente' %>">€ <%= Number(r.comision_ventas || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                          </tr>
                        <% }) %>
                      </tbody>
                      <tfoot>
                        <tr class="table-light">
                          <th scope="row" colspan="3" class="text-end">Subtotal <%= g.marca_nombre %></th>
                          <th class="text-end">€ <%= Number(g.subtotal_base || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></th>
                          <th class="text-end"><%= Number(g.pct_efectivo || 0).toFixed(2) %>%</th>
                          <th class="text-end fw-bold <%= ventasPagadas ? 'importe-pagado' : 'importe-pendiente' %>">€ <%= Number(g.subtotal_comision || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></th>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              <% }) %>
            <% } %>
          </div>
        </div>

        <div class="card">
          <div class="card-header bg-light">
            <h5 class="mb-0">
              <i class="fas fa-coins me-2"></i>Fijo mensual por marca (periodo)
              <span class="badge bg-warning text-dark ms-2">€ <%= Number(totales.total_fijo_marca || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
              <span class="badge <%= fijoPagado ? 'bg-success' : 'bg-secondary' %> ms-2"><%= fijoPagado ? 'Fijo pagado' : 'Fijo pendiente' %></span>
            </h5>
          </div>
          <div class="card-body">
            <% if (!fijosPorMarca || fijosPorMarca.length === 0) { %>
              <div class="alert alert-secondary mb-0">No hay fijo mensual configurado por marca para este periodo.</div>
            <% } else { %>
              <div class="table-responsive">
                <table class="table table-sm table-striped align-middle">
                  <caption class="text-muted">Importes de fijo mensual configurados por marca para el comercial y el periodo.</caption>
                  <thead>
                    <tr>
                      <th scope="col">Marca</th>
                      <th scope="col" class="text-end">Importe fijo</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% fijosPorMarca.forEach(f => { %>
                      <tr class="<%= fijoPagado ? 'table-success' : '' %>">
                        <td><%= f.marca_nombre %></td>
                        <td class="text-end fw-bold <%= fijoPagado ? 'importe-pagado' : 'importe-pendiente' %>">€ <%= Number(f.importe || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                      </tr>
                    <% }) %>
                  </tbody>
                  <tfoot>
                    <tr class="table-light">
                      <th scope="row" class="text-end">Total fijo</th>
                      <th class="text-end fw-bold <%= fijoPagado ? 'importe-pagado' : 'importe-pendiente' %>">€ <%= Number(totales.total_fijo_marca || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></th>
                    </tr>
                  </tfoot>
                </table>
              </div>
            <% } %>
          </div>
        </div>

        <!-- (Eliminado) zona de firmas -->

      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    async function pagarConcepto(concepto) {
      const fecha = document.getElementById('fechaPagoConcepto')?.value || new Date().toISOString().split('T')[0];
      const ok = confirm(`¿Marcar como pagado el concepto "${concepto}" con fecha ${fecha}?`);
      if (!ok) return;

      try {
        const res = await fetch(`/dashboard/comisiones/comisiones/<%= comision.id %>/pagar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ concepto, fecha_pago: fecha })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.success === false) {
          throw new Error(data.error || `HTTP ${res.status}`);
        }
        window.location.reload();
      } catch (e) {
        alert(`No se pudo registrar el pago: ${e.message}`);
      }
    }
  </script>
</body>
</html>

