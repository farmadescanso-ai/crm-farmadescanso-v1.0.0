<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comisiones - Farmadescaso CRM</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/colors.css" rel="stylesheet">
    <link href="/css/dashboard.css" rel="stylesheet">
    <%- include('../../partials/navbar-styles') %>
    <style>
        .importe-pagado {
            color: #198754 !important; /* bootstrap success */
            font-weight: 700;
        }
    </style>
</head>
<body>
    <%- include('../../partials/navbar-dashboard') %>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar bg-light p-0">
                <div class="sidebar-content">
                    <div class="user-info p-3 border-bottom">
                        <div class="d-flex align-items-center">
                            <div class="user-avatar me-3">
                                <i class="fas fa-user-circle text-primary"></i>
                            </div>
                            <div>
                                <h6 class="mb-0 fw-bold"><%= user.nombre %></h6>
                                <small class="text-muted"><%= user.zona || '' %></small>
                            </div>
                        </div>
                    </div>
                    <nav class="sidebar-nav p-3">
                        <ul class="nav flex-column">
                            <li class="nav-item mb-2">
                                <a class="nav-link" href="/dashboard">
                                    <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                                </a>
                            </li>
                            <li class="nav-item mb-2">
                                <a class="nav-link" href="/dashboard/articulos">
                                    <i class="fas fa-boxes me-2"></i>Artículos
                                </a>
                            </li>
                            <li class="nav-item mb-2">
                                <a class="nav-link" href="/dashboard/clientes">
                                    <i class="fas fa-users me-2"></i>Clientes
                                </a>
                            </li>
                            <li class="nav-item mb-2">
                                <a class="nav-link" href="/dashboard/pedidos">
                                    <i class="fas fa-shopping-cart me-2"></i>Pedidos
                                </a>
                            </li>
                            <li class="nav-item mb-2">
                                <a class="nav-link" href="/dashboard/agenda">
                                    <i class="fas fa-calendar-check me-2"></i>Agenda
                                </a>
                            </li>
                            <% if (typeof esAdmin !== 'undefined' && esAdmin) { %>
                            <li class="nav-item mb-2">
                                <a class="nav-link" href="#" data-bs-toggle="collapse" data-bs-target="#comisionesSubmenu" aria-expanded="true" aria-controls="comisionesSubmenu" id="comisionesMenuToggle">
                                    <i class="fas fa-euro-sign me-2"></i>Comisiones
                                    <i class="fas fa-chevron-down ms-auto float-end" id="comisionesChevron" style="font-size: 0.75rem; transition: transform 0.3s; transform: rotate(180deg);"></i>
                                </a>
                                <ul class="nav flex-column collapse show" id="comisionesSubmenu" style="margin-left: 1.5rem; border-left: 2px solid #dee2e6; padding-left: 0.5rem;">
                                    <li class="nav-item mb-1">
                                        <a class="nav-link" href="/dashboard/comisiones/presupuestos">
                                            <i class="fas fa-chart-line me-2"></i>Presupuestos
                                        </a>
                                    </li>
                                    <li class="nav-item mb-1">
                                        <a class="nav-link active" href="/dashboard/comisiones/comisiones">
                                            <i class="fas fa-money-bill-wave me-2"></i>Comisiones
                                        </a>
                                    </li>
                                    <li class="nav-item mb-1">
                                        <a class="nav-link" href="/dashboard/comisiones/rapeles">
                                            <i class="fas fa-trophy me-2"></i>Rapeles
                                        </a>
                                    </li>
                                    <li class="nav-item mb-1">
                                        <a class="nav-link" href="/dashboard/comisiones/objetivos-marca">
                                            <i class="fas fa-bullseye me-2"></i>Objetivos por Marca
                                        </a>
                                    </li>
                                    <li class="nav-item mb-1">
                                        <a class="nav-link" href="/dashboard/comisiones/condiciones-especiales">
                                            <i class="fas fa-star me-2"></i>Condiciones Especiales
                                        </a>
                                    </li>
                                    <li class="nav-item mb-1">
                                        <a class="nav-link" href="/dashboard/comisiones/rapeles-configuracion">
                                            <i class="fas fa-cog me-2"></i>Config. Rapeles
                                        </a>
                                    </li>
                                </ul>
                            </li>
                            <% } %>
                            <li class="nav-item mb-2">
                                <a class="nav-link" href="/dashboard/comerciales">
                                    <i class="fas fa-user-tie me-2"></i>Comerciales
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>

            <main class="col-md-9 col-lg-10 ms-sm-auto px-md-4 main-content">
        <div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">
                <i class="fas fa-money-bill-wave me-2 text-primary"></i>
                <% if (typeof esAdmin !== 'undefined' && esAdmin) { %>
                Comisiones
                <% } else { %>
                Mis Comisiones
                <% } %>
            </h1>
        </div>

        <!-- Filtros -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="GET" action="/dashboard/comisiones/comisiones" class="row g-3">
                    <% 
                    const comercialIdParaFiltro = typeof comercialIdAutenticado !== 'undefined' && comercialIdAutenticado ? comercialIdAutenticado : (typeof filters !== 'undefined' && filters && filters.comercial_id ? filters.comercial_id : '');
                    const mostrarSelectComercial = typeof esAdmin !== 'undefined' && esAdmin;
                    %>
                    <% if (mostrarSelectComercial) { %>
                    <div class="col-md-3">
                        <label class="form-label">Comercial</label>
                        <select name="comercial_id" class="form-select">
                            <option value="">Todos</option>
                            <% comerciales.forEach(comercial => { %>
                            <option value="<%= comercial.id || comercial.Id %>" <%= filters.comercial_id == (comercial.id || comercial.Id) ? 'selected' : '' %>>
                                <%= comercial.Nombre || comercial.nombre %>
                            </option>
                            <% }) %>
                        </select>
                    </div>
                    <% } else { %>
                    <div class="col-md-3">
                        <label class="form-label">Comercial</label>
                        <% 
                        const comercialAutenticado = typeof comerciales !== 'undefined' && comerciales && Array.isArray(comerciales) && comercialIdParaFiltro 
                            ? comerciales.find(c => (c.id || c.Id) == comercialIdParaFiltro) 
                            : null;
                        const nombreComercial = comercialAutenticado ? (comercialAutenticado.Nombre || comercialAutenticado.nombre || 'Sin nombre') : 'Sin asignar';
                        %>
                        <input type="hidden" name="comercial_id" value="<%= comercialIdParaFiltro %>">
                        <input type="text" class="form-control" value="<%= nombreComercial %>" disabled readonly style="background-color: #e9ecef; cursor: not-allowed;">
                        <small class="text-muted"><i class="fas fa-info-circle"></i> Solo puedes ver tus propias comisiones</small>
                    </div>
                    <% } %>
                    <div class="col-md-2">
                        <label class="form-label">Mes</label>
                        <select name="mes" class="form-select">
                            <option value="">Todos</option>
                            <% for (let i = 1; i <= 12; i++) { %>
                            <option value="<%= i %>" <%= filters.mes == i ? 'selected' : '' %>>
                                <%= ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'][i-1] %>
                            </option>
                            <% } %>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Año</label>
                        <input type="number" name="año" class="form-control" value="<%= filters.año || new Date().getFullYear() %>" min="2020" max="2030">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Estado</label>
                        <select name="estado" class="form-select">
                            <option value="">Todos</option>
                            <option value="Pendiente" <%= filters.estado === 'Pendiente' ? 'selected' : '' %>>Pendiente</option>
                            <option value="Calculado" <%= (filters.estado === 'Calculado' || filters.estado === 'Calculada') ? 'selected' : '' %>>Calculado</option>
                            <option value="Pagado" <%= (filters.estado === 'Pagado' || filters.estado === 'Pagada') ? 'selected' : '' %>>Pagado</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-outline-primary w-100">
                            <i class="fas fa-filter me-1"></i>Filtrar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabla de comisiones -->
        <div class="card">
            <div class="card-body">
                <% if (typeof esAdmin !== 'undefined' && esAdmin) { %>
                <div class="small text-muted mb-2">
                    <span class="importe-pagado">Verde</span> = concepto pagado (ventas/fijo). Si no está pagado, se muestra sin marcar.
                </div>
                <% } %>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <% if (typeof esAdmin !== 'undefined' && esAdmin) { %>
                                <th class="text-center">
                                    <input type="checkbox" id="chkSelectAllComisiones" aria-label="Seleccionar todas las comisiones">
                                </th>
                                <% } %>
                                <% if (typeof esAdmin !== 'undefined' && esAdmin) { %>
                                <th>Comercial</th>
                                <% } %>
                                <th>Mes/Año</th>
                                <th class="text-end">Fijo Mensual</th>
                                <th class="text-end">Comisión Ventas</th>
                                <th class="text-end">Total Comisión</th>
                                <th class="text-center">Estado</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (comisiones && comisiones.length > 0) { %>
                            <% comisiones.forEach(comision => { %>
                            <% 
                                const ventasPagadas = !!(comision.fecha_pago_ventas || (comision.estado === 'Pagado' || comision.estado === 'Pagada'));
                                const fijoPagado = !!(comision.fecha_pago_fijo || (comision.estado === 'Pagado' || comision.estado === 'Pagada'));
                                const totalPagado = ventasPagadas && fijoPagado;
                            %>
                            <tr>
                                <% if (typeof esAdmin !== 'undefined' && esAdmin) { %>
                                <td class="text-center">
                                    <input
                                      type="checkbox"
                                      class="chkComisionRow"
                                      value="<%= comision.id %>"
                                      data-comercial-id="<%= comision.comercial_id %>"
                                      data-mes="<%= comision.mes %>"
                                      data-año="<%= comision.año %>"
                                      aria-label="Seleccionar comisión <%= (comision.mes && comision.mes > 0) ? (['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][comision.mes-1] + '/' + comision.año) : (comision.año) %>"
                                    >
                                </td>
                                <% } %>
                                <% if (typeof esAdmin !== 'undefined' && esAdmin) { %>
                                <td><%= comision.comercial_nombre || '-' %></td>
                                <% } %>
                                <td>
                                    <% if (comision.mes && comision.mes > 0) { %>
                                    <%= ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'][comision.mes - 1] %>/<%= comision.año %>
                                    <% } else { %>
                                    <%= comision.año %>
                                    <% } %>
                                </td>
                                <td class="text-end <%= fijoPagado ? 'importe-pagado' : '' %>">€ <%= parseFloat(comision.fijo_mensual || 0).toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                                <td class="text-end <%= ventasPagadas ? 'importe-pagado' : '' %>">€ <%= parseFloat(comision.comision_ventas || 0).toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                                <td class="text-end fw-bold <%= totalPagado ? 'importe-pagado' : '' %>">€ <%= parseFloat(comision.total_comision || 0).toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></td>
                                <td class="text-center">
                                    <% if (comision.estado === 'Pagado' || comision.estado === 'Pagada') { %>
                                    <span class="badge bg-success">Pagado</span>
                                    <% } else if (comision.estado === 'Calculado' || comision.estado === 'Calculada') { %>
                                    <span class="badge bg-info">Calculado</span>
                                    <% } else { %>
                                    <span class="badge bg-warning">Pendiente</span>
                                    <% } %>
                                </td>
                                <td class="text-center">
                                    <a href="/dashboard/comisiones/comisiones/<%= comision.id %>" class="btn btn-sm btn-outline-primary" title="Ver Detalle">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="/dashboard/comisiones/comisiones/<%= comision.id %>/liquidacion" class="btn btn-sm btn-outline-dark" title="Documento de liquidación (Comisiones de Ventas)" target="_blank" rel="noopener">
                                        <i class="fas fa-file-invoice-dollar"></i>
                                    </a>
                                    <% if ((typeof esAdmin !== 'undefined' && esAdmin) && comision.mes && comision.mes > 0 && comision.año) { %>
                                    <button class="btn btn-sm btn-outline-warning" onclick="recalcularComision(<%= comision.comercial_id %>, <%= comision.mes %>, <%= comision.año %>)" title="Recalcular comisiones (mes)">
                                        <i class="fas fa-rotate-right"></i>
                                    </button>
                                    <% } %>
                                    <% if ((typeof esAdmin !== 'undefined' && esAdmin)) { %>
                                    <button class="btn btn-sm btn-outline-success" onclick="marcarComoPagada(<%= comision.id %>)" title="Registrar pago (Ventas/Fijo)">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <% if (comision.estado !== 'Pagado' && comision.estado !== 'Pagada') { %>
                                    <button class="btn btn-sm btn-outline-danger" onclick="borrarComision(<%= comision.id %>)" title="Borrar comisión (admin)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <% } %>
                                    <% } %>
                                </td>
                            </tr>
                            <% }) %>
                            <% } else { %>
                            <tr>
                                <td colspan="<%= (typeof esAdmin !== 'undefined' && esAdmin) ? '8' : '6' %>" class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                                    No hay comisiones registradas
                                </td>
                            </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
                <% if (typeof esAdmin !== 'undefined' && esAdmin) { %>
                <div class="d-flex flex-wrap gap-2 align-items-center mt-3">
                    <button class="btn btn-outline-dark" id="btnLiquidarSeleccionadas" disabled>
                        <i class="fas fa-file-invoice-dollar me-1"></i>Liquidar seleccionadas
                    </button>
                    <small class="text-muted" id="txtSeleccionInfo">0 seleccionadas</small>
                </div>
                <% } %>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Mantener submenú de comisiones abierto
        document.addEventListener('DOMContentLoaded', function() {
            const comisionesSubmenu = document.getElementById('comisionesSubmenu');
            if (comisionesSubmenu) {
                comisionesSubmenu.classList.add('show');
            }
        });

        async function marcarComoPagada(id) {
            const concepto = prompt('¿Qué concepto quieres marcar como pagado? Escribe: ventas, fijo o ambos', 'ventas');
            if (!concepto) return;
            const fecha = new Date().toISOString().split('T')[0];
            if (!confirm(`¿Marcar como pagado "${concepto}" con fecha ${fecha}?`)) return;

            try {
                const response = await fetch(`/dashboard/comisiones/comisiones/${id}/pagar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ concepto: String(concepto).toLowerCase(), fecha_pago: fecha })
                });

                const data = await response.json();
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo marcar como pagada'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al marcar como pagada');
            }
        }

        async function recalcularComision(comercialId, mes, año) {
            const confirmado = confirm(`¿Recalcular comisiones del ${String(mes).padStart(2,'0')}/${año} para el comercial #${comercialId}?`);
            if (!confirmado) return;

            try {
                const response = await fetch('/dashboard/comisiones/comisiones/calcular', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ comercial_id: comercialId, mes, año })
                });

                const data = await response.json().catch(() => ({}));
                if (!response.ok || data.success === false) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }
                location.reload();
            } catch (error) {
                console.error('Error:', error);
                alert('Error al recalcular: ' + (error.message || 'desconocido'));
            }
        }

        async function borrarComision(id) {
            const ok = confirm('⚠️ ¿Borrar esta comisión?\n\nSe eliminarán también sus detalles y su estado asociado.\nNo se permite borrar si está marcada como PAGADA.');
            if (!ok) return;
            try {
                const res = await fetch(`/dashboard/comisiones/comisiones/${id}`, {
                    method: 'DELETE',
                    headers: { 'Accept': 'application/json' },
                    credentials: 'include'
                });
                const data = await res.json().catch(() => ({}));
                if (!res.ok || data.success === false) {
                    throw new Error(data.error || `HTTP ${res.status}`);
                }
                location.reload();
            } catch (e) {
                alert(`No se pudo borrar: ${e.message}`);
            }
        }

        // Selección múltiple para liquidación de varios meses
        document.addEventListener('DOMContentLoaded', function() {
            const chkAll = document.getElementById('chkSelectAllComisiones');
            const btnLiquidar = document.getElementById('btnLiquidarSeleccionadas');
            const txtInfo = document.getElementById('txtSeleccionInfo');
            const rows = Array.from(document.querySelectorAll('.chkComisionRow'));
            if (!btnLiquidar || rows.length === 0) return;

            const updateUI = () => {
                const selected = rows.filter(r => r.checked);
                if (txtInfo) txtInfo.textContent = `${selected.length} seleccionadas`;
                btnLiquidar.disabled = selected.length === 0;
                if (chkAll) chkAll.checked = selected.length > 0 && selected.length === rows.length;
            };

            if (chkAll) {
                chkAll.addEventListener('change', () => {
                    rows.forEach(r => { r.checked = chkAll.checked; });
                    updateUI();
                });
            }

            rows.forEach(r => r.addEventListener('change', updateUI));

            btnLiquidar.addEventListener('click', () => {
                const selected = rows.filter(r => r.checked);
                if (selected.length === 0) return;
                const comercialIds = [...new Set(selected.map(r => String(r.dataset.comercialId || '')))].filter(Boolean);
                if (comercialIds.length > 1) {
                    alert('Para liquidar varios meses a la vez, selecciona comisiones de un único comercial.');
                    return;
                }
                const ids = selected.map(r => r.value).join(',');
                const url = `/dashboard/comisiones/comisiones/liquidacion-multiple?ids=${encodeURIComponent(ids)}`;
                window.open(url, '_blank', 'noopener');
            });

            updateUI();
        });
    </script>
<script src="/js/go-to-top.js"></script>
    <!-- Go to Top Button -->
    <button id="goToTop" class="go-to-top" title="Ir arriba">
        <i class="fas fa-arrow-up"></i>
    </button>
</body>
</html>
