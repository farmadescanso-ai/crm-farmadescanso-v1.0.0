<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/colors.css" rel="stylesheet">
    <link href="/css/dashboard.css" rel="stylesheet">
    <style>
        .tipo-visita-selector {
            transition: all 0.3s ease;
        }
        .campo-condicional {
            display: none;
        }
        .campo-condicional.show {
            display: block;
        }
    </style>

    <%- include('../partials/navbar-styles') %></head>
<body>
    <%- include('../partials/navbar-dashboard') %>

    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0 text-primary"><i class="fas fa-edit me-2"></i>Editar Cita</h3>
        </div>

        <% if (error) { %>
        <div class="alert alert-danger"><%= error %></div>
        <% } %>

        <form method="POST" action="/dashboard/agenda/<%= visita.Id || visita.id %>/editar" id="visitaForm">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">Informaci√≥n de la Cita</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Comercial <span class="text-danger">*</span></label>
                            <% 
                            const visitaComercialRef = visita.Comerciales || visita._nc_m2m_Visitas_Comerciales;
                            let visitaComercialId = null;
                            if (typeof visitaComercialRef === 'number') {
                                visitaComercialId = visitaComercialRef;
                            } else if (Array.isArray(visitaComercialRef) && visitaComercialRef.length > 0) {
                                visitaComercialId = visitaComercialRef[0]?.Comerciales_id || visitaComercialRef[0]?.Comerciales?.Id;
                            }
                            const comercialSeleccionado = formValues.comercial_id || visitaComercialId || (user && (user.Id || user.id));
                            const isAdmin = (user && user.Roll && user.Roll.toLowerCase() === 'administrador') || (user && user.roll && user.roll.toLowerCase() === 'administrador');
                            %>
                            <select name="comercial_id" id="comercial_id" class="form-select" required 
                                    <%= isAdmin ? '' : 'readonly' %>>
                                <option value="">‚Äî Seleccionar comercial ‚Äî</option>
                                <% comerciales.forEach(comercial => { %>
                                    <% const comercialId = comercial.Id || comercial.id; %>
                                    <option value="<%= comercialId %>" 
                                            <%= String(comercialSeleccionado) === String(comercialId) ? 'selected' : '' %>>
                                        <%= comercial.Nombre || comercial.nombre %>
                                    </option>
                                <% }) %>
                            </select>
                            <small class="form-text text-muted">
                                <% if (isAdmin) { %>
                                    Selecciona el comercial responsable de esta visita
                                <% } else { %>
                                    Por defecto se asignar√° el comercial logueado (solo administradores pueden cambiarlo)
                                <% } %>
                            </small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Tipo de Visita <span class="text-danger">*</span></label>
                            <% const tipoVisitaActual = formValues.TipoVisita || formValues.tipoVisita || visita.TipoVisita || visita.tipoVisita || visita.Tipo_Visita || visita.tipo_visita || 'Farmacia'; %>
                            <select name="tipo_visita" id="tipoVisita" class="form-select tipo-visita-selector" required>
                                <option value="Farmacia" <%= tipoVisitaActual === 'Farmacia' ? 'selected' : '' %>>üíä Farmacia</option>
                                <option value="Sanitarios" <%= tipoVisitaActual === 'Sanitarios' || tipoVisitaActual === 'Centro Salud' ? 'selected' : '' %>>üè• Sanitarios</option>
                                <option value="Reuni√≥n" <%= tipoVisitaActual === 'Reuni√≥n' ? 'selected' : '' %>>ü§ù Reuni√≥n</option>
                                <option value="Notas" <%= tipoVisitaActual === 'Notas' ? 'selected' : '' %>>üìù Notas</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Fecha <span class="text-danger">*</span></label>
                            <% const fechaVisita = visita.Fecha || visita.fecha || visita.Fecha_Visita || visita.fecha_visita; %>
                            <% const fechaFormatted = fechaVisita ? new Date(fechaVisita).toISOString().split('T')[0] : ''; %>
                            <input type="date" name="fecha" class="form-control" value="<%= formValues.fecha || fechaFormatted || '' %>" required>
                        </div>
                        
                        <!-- Selector de Farmacia (Cliente) - Solo visible cuando tipo es "Farmacia" -->
                        <div class="col-md-6 campo-condicional" id="campoFarmacia">
                            <label class="form-label fw-semibold">Farmacia <span class="text-danger">*</span></label>
                            <% 
                            // Intentar obtener el ID del cliente desde diferentes campos posibles
                            const visitaClienteRef = visita.FarmaciaCliente || visita.Cliente_id || visita.cliente_id || visita.Cliente_Id || visita.cliente_Id;
                            let visitaClienteId = null;
                            if (typeof visitaClienteRef === 'number' && visitaClienteRef !== 0) {
                                visitaClienteId = visitaClienteRef;
                            } else if (typeof visitaClienteRef === 'object' && visitaClienteRef !== null) {
                                visitaClienteId = visitaClienteRef.Id || visitaClienteRef.id;
                            } else if (visitaClienteRef) {
                                visitaClienteId = visitaClienteRef;
                            }
                            %>
                            <select name="cliente_id" id="cliente_id" class="form-select">
                                <option value="">‚Äî Seleccionar farmacia ‚Äî</option>
                                <% clientes.forEach(cliente => { %>
                                    <% 
                                    const clienteId = cliente.Id || cliente.id;
                                    const direccionCliente = cliente.Direccion || cliente.direccion || cliente.CALLE || cliente.calle || cliente.Direcci√≥n || cliente.direcci√≥n || '';
                                    const codigoPostal = cliente.CodigoPostal || cliente.codigoPostal || cliente.Codigo_Postal || cliente.codigo_postal || cliente.CP || cliente.cp || cliente['C√≥digo Postal'] || cliente['c√≥digo postal'] || '';
                                    const poblacion = cliente.Poblacion || cliente.poblacion || cliente.Poblaci√≥n || cliente.poblaci√≥n || cliente.Ciudad || cliente.ciudad || cliente.City || cliente.city || '';
                                    %>
                                    <option value="<%= clienteId %>" 
                                            data-direccion="<%= direccionCliente %>"
                                            data-codigo-postal="<%= codigoPostal %>"
                                            data-poblacion="<%= poblacion %>"
                                            data-telefono="<%= cliente.Telefono || cliente.telefono || cliente.Telefono_Contacto || cliente.telefono_contacto || '' %>"
                                            <%= String(formValues.cliente_id || visitaClienteId || '') === String(clienteId) ? 'selected' : '' %>>
                                        <%= cliente.Nombre || cliente.nombre %>
                                    </option>
                                <% }) %>
                            </select>
                        </div>
                        
                        <!-- Campo de Impactos Farmacia - Solo visible cuando tipo es "Farmacia" -->
                        <div class="col-md-6 campo-condicional" id="campoImpactosFarmacia">
                            <label class="form-label fw-semibold">Impactos Farmacia</label>
                            <% 
                            const impactosFarmaciaActual = formValues.impactos_farmacia || formValues.ImpactosFarmacia || visita.ImpactosFarmacia || visita.cii5t6mnoj9v3uo || '0';
                            %>
                            <input type="number" name="impactos_farmacia" id="impactos_farmacia" class="form-control" 
                                   value="<%= impactosFarmaciaActual %>" 
                                   min="0" step="1" placeholder="0">
                            <small class="form-text text-muted">N√∫mero de impactos comerciales para esta farmacia</small>
                        </div>

                        <!-- Selector de Centro de Salud - Solo visible cuando tipo es "Sanitarios" -->
                        <div class="col-md-6 campo-condicional" id="campoCentroSalud">
                            <label class="form-label fw-semibold">Centro de Salud <span class="text-danger">*</span></label>
                            <% 
                            // Intentar obtener el ID del centro desde diferentes campos posibles
                            const visitaCentroRef = visita.CentroSalud || visita.Centro_Salud_id || visita.centro_salud_id || visita.Centro_Salud_Id || visita.centro_Salud_Id;
                            let visitaCentroId = null;
                            if (typeof visitaCentroRef === 'number' && visitaCentroRef !== 0) {
                                visitaCentroId = visitaCentroRef;
                            } else if (typeof visitaCentroRef === 'object' && visitaCentroRef !== null) {
                                visitaCentroId = visitaCentroRef.Id || visitaCentroRef.id;
                            } else if (visitaCentroRef) {
                                visitaCentroId = visitaCentroRef;
                            }
                            %>
                            <select name="centro_salud_id" id="centro_salud_id" class="form-select">
                                <option value="">‚Äî Seleccionar centro de salud ‚Äî</option>
                                <% centrosSalud.forEach(centro => { %>
                                    <% 
                                    const centroId = centro.Id || centro.id;
                                    const direccionCentro = centro.Direccion || centro.direccion || centro.CALLE || centro.calle || centro.Direcci√≥n || centro.direcci√≥n || '';
                                    const codigoPostal = centro.CodigoPostal || centro.codigoPostal || centro.Codigo_Postal || centro.codigo_postal || centro.CP || centro.cp || centro['C√≥digo Postal'] || centro['c√≥digo postal'] || '';
                                    const poblacion = centro.Poblacion || centro.poblacion || centro.Poblaci√≥n || centro.poblaci√≥n || centro.Ciudad || centro.ciudad || centro.City || centro.city || '';
                                    %>
                                    <option value="<%= centroId %>" 
                                            data-direccion="<%= direccionCentro %>"
                                            data-codigo-postal="<%= codigoPostal %>"
                                            data-poblacion="<%= poblacion %>"
                                            data-telefono="<%= centro.Telefono || centro.telefono || centro.Telefono_Contacto || centro.telefono_contacto || '' %>"
                                            <%= String(formValues.centro_salud_id || visitaCentroId || '') === String(centroId) ? 'selected' : '' %>>
                                        <%= centro.nombreMostrar || centro.coqmahyqo5gi3yc || centro.Nombre || centro.nombre || 'Centro sin nombre' %>
                                    </option>
                                <% }) %>
                            </select>
                        </div>
                        
                        <!-- Campo de Impactos Centro Salud - Solo visible cuando tipo es "Sanitarios" -->
                        <div class="col-md-6 campo-condicional" id="campoImpactosCentroSalud">
                            <label class="form-label fw-semibold">Impactos Centro Salud</label>
                            <% 
                            const impactosCentroSaludActual = formValues.impactos_centro_salud || formValues.ImpactosCentroSalud || visita.ImpactosCentroSalud || visita.cu2rrm8y6uatep9 || '0';
                            %>
                            <input type="number" name="impactos_centro_salud" id="impactos_centro_salud" class="form-control" 
                                   value="<%= impactosCentroSaludActual %>" 
                                   min="0" step="1" placeholder="0">
                            <small class="form-text text-muted">N√∫mero de impactos comerciales para este centro de salud</small>
                        </div>

                        <!-- Campo de texto para Reuni√≥n y Otro -->
                        <div class="col-md-6 campo-condicional" id="campoTipoDetalle">
                            <label class="form-label fw-semibold">Descripci√≥n del tipo <span class="text-danger">*</span></label>
                            <% const tipoDetalleActual = formValues.Tipo || formValues.tipo || visita.Tipo || visita.tipo || visita.Descripcion || visita.descripcion || ''; %>
                            <input type="text" name="tipo_detalle" id="tipo_detalle" class="form-control" 
                                   value="<%= formValues.tipo_detalle || tipoDetalleActual || '' %>" 
                                   placeholder="Describe el tipo de visita (ej: Reuni√≥n con equipo, Presentaci√≥n de producto, etc.)">
                            <small class="form-text text-muted">Describe el tipo de visita que vas a realizar</small>
                        </div>
                        
                        <!-- Campo de URL de reuni√≥n - Solo visible cuando tipo es "Reuni√≥n" -->
                        <div class="col-12 campo-condicional" id="campoEnlaceReunion">
                            <label class="form-label fw-semibold">Enlace de Reuni√≥n</label>
                            <% const enlaceReunionActual = formValues.enlace_reunion || formValues.EnalaceReunion || formValues.EnlaceReunion || visita.EnalaceReunion || visita.EnlaceReunion || visita.enlace_reunion || ''; %>
                            <div class="input-group">
                                <input type="url" name="enlace_reunion" id="enlace_reunion" class="form-control" 
                                       value="<%= enlaceReunionActual %>" 
                                       placeholder="https://meet.google.com/xxx-xxxx-xxx o URL de Teams, Zoom, etc.">
                                <button type="button" class="btn btn-outline-primary" id="btnGenerarMeet" title="Generar enlace de Google Meet">
                                    <i class="fab fa-google me-1"></i>Generar Meet
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="btnProbarEnlace" title="Probar enlace">
                                    <i class="fas fa-external-link-alt"></i>
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                Puedes generar un enlace de Google Meet autom√°ticamente o pegar una URL de cualquier herramienta (Meet, Teams, Zoom, etc.)
                            </small>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Hora</label>
                            <input type="time" name="hora" class="form-control" value="<%= formValues.hora || visita.Hora || visita.hora || visita.Hora_Visita || visita.hora_visita || '09:00' %>">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Estado</label>
                            <select name="estado" class="form-select">
                                <option value="Pendiente" <%= (formValues.estado || visita.Estado || visita.estado || 'Pendiente') === 'Pendiente' ? 'selected' : '' %>>Pendiente</option>
                                <option value="Confirmada" <%= (formValues.estado || visita.Estado || visita.estado || '') === 'Confirmada' ? 'selected' : '' %>>Confirmada</option>
                                <option value="Completada" <%= (formValues.estado || visita.Estado || visita.estado || '') === 'Completada' ? 'selected' : '' %>>Completada</option>
                                <option value="Cancelada" <%= (formValues.estado || visita.Estado || visita.estado || '') === 'Cancelada' ? 'selected' : '' %>>Cancelada</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Direcci√≥n</label>
                            <input type="text" name="direccion" id="direccion" class="form-control" value="<%= formValues.direccion || visita.Direccion || visita.direccion || '' %>" placeholder="Direcci√≥n de la visita">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Tel√©fono</label>
                            <input type="text" name="telefono" id="telefono" class="form-control" value="<%= formValues.telefono || visita.Telefono || visita.telefono || '' %>" placeholder="Tel√©fono de contacto">
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-semibold">Observaciones</label>
                            <textarea name="observaciones" class="form-control" rows="3" placeholder="Notas adicionales sobre la cita..."><%= formValues.observaciones || visita.Observaciones || visita.observaciones || visita.Notas || visita.notas || '' %></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-end gap-2">
                <a href="/dashboard/agenda/<%= visita.Id || visita.id %>" class="btn btn-outline-secondary">Cancelar</a>
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const tipoVisitaSelect = document.getElementById('tipoVisita');
        const campoFarmacia = document.getElementById('campoFarmacia');
        const campoCentroSalud = document.getElementById('campoCentroSalud');
        const campoImpactosFarmacia = document.getElementById('campoImpactosFarmacia');
        const campoImpactosCentroSalud = document.getElementById('campoImpactosCentroSalud');
        const campoTipoDetalle = document.getElementById('campoTipoDetalle');
        const campoEnlaceReunion = document.getElementById('campoEnlaceReunion');
        const clienteSelect = document.getElementById('cliente_id');
        const centroSaludSelect = document.getElementById('centro_salud_id');
        const tipoDetalleInput = document.getElementById('tipo_detalle');
        const direccionInput = document.getElementById('direccion');
        const telefonoInput = document.getElementById('telefono');
        const enlaceReunionInput = document.getElementById('enlace_reunion');
        const btnGenerarMeet = document.getElementById('btnGenerarMeet');
        const btnProbarEnlace = document.getElementById('btnProbarEnlace');

        function actualizarCampos() {
            const tipo = tipoVisitaSelect.value;
            
            // Ocultar todos los campos condicionales
            campoFarmacia.classList.remove('show');
            campoCentroSalud.classList.remove('show');
            campoImpactosFarmacia.classList.remove('show');
            campoImpactosCentroSalud.classList.remove('show');
            campoTipoDetalle.classList.remove('show');
            campoEnlaceReunion.classList.remove('show');
            
            // Remover required de todos
            clienteSelect.removeAttribute('required');
            centroSaludSelect.removeAttribute('required');
            tipoDetalleInput.removeAttribute('required');

            // Limpiar direcci√≥n y tel√©fono cuando cambia el tipo
            direccionInput.value = '';
            telefonoInput.value = '';

            // Mostrar campos seg√∫n el tipo
            if (tipo === 'Farmacia') {
                campoFarmacia.classList.add('show');
                campoImpactosFarmacia.classList.add('show');
                clienteSelect.setAttribute('required', 'required');
                // Si ya hay un cliente seleccionado, rellenar sus datos
                if (clienteSelect.value) {
                    rellenarDatosCliente();
                }
            } else if (tipo === 'Sanitarios') {
                campoCentroSalud.classList.add('show');
                campoImpactosCentroSalud.classList.add('show');
                centroSaludSelect.setAttribute('required', 'required');
                // Si ya hay un centro de salud seleccionado, rellenar sus datos
                if (centroSaludSelect.value) {
                    rellenarDatosCentroSalud();
                }
            } else if (tipo === 'Reuni√≥n' || tipo === 'Notas') {
                campoTipoDetalle.classList.add('show');
                tipoDetalleInput.setAttribute('required', 'required');
                // Mostrar campo de enlace de reuni√≥n solo para Reuni√≥n
                if (tipo === 'Reuni√≥n') {
                    campoEnlaceReunion.classList.add('show');
                }
            }
        }

        // Funci√≥n para construir direcci√≥n completa con c√≥digo postal y poblaci√≥n
        function construirDireccionCompleta(direccion, codigoPostal, poblacion) {
            let direccionCompleta = direccion || '';
            
            // Agregar c√≥digo postal y poblaci√≥n si existen
            const partes = [];
            if (direccionCompleta) partes.push(direccionCompleta);
            if (codigoPostal && poblacion) {
                partes.push(codigoPostal + ' ' + poblacion);
            } else if (codigoPostal) {
                partes.push(codigoPostal);
            } else if (poblacion) {
                partes.push(poblacion);
            }
            
            return partes.join(', ');
        }

        // Funci√≥n para rellenar direcci√≥n y tel√©fono desde el cliente seleccionado
        function rellenarDatosCliente() {
            const selectedOption = clienteSelect.options[clienteSelect.selectedIndex];
            if (selectedOption && selectedOption.value) {
                const direccion = selectedOption.getAttribute('data-direccion') || '';
                const codigoPostal = selectedOption.getAttribute('data-codigo-postal') || '';
                const poblacion = selectedOption.getAttribute('data-poblacion') || '';
                const telefono = selectedOption.getAttribute('data-telefono') || '';
                
                const direccionCompleta = construirDireccionCompleta(direccion, codigoPostal, poblacion);
                direccionInput.value = direccionCompleta;
                telefonoInput.value = telefono;
            } else {
                // Si no hay selecci√≥n, limpiar campos
                direccionInput.value = '';
                telefonoInput.value = '';
            }
        }

        // Funci√≥n para rellenar direcci√≥n y tel√©fono desde el centro de salud seleccionado
        function rellenarDatosCentroSalud() {
            const selectedOption = centroSaludSelect.options[centroSaludSelect.selectedIndex];
            if (selectedOption && selectedOption.value) {
                const direccion = selectedOption.getAttribute('data-direccion') || '';
                const codigoPostal = selectedOption.getAttribute('data-codigo-postal') || '';
                const poblacion = selectedOption.getAttribute('data-poblacion') || '';
                const telefono = selectedOption.getAttribute('data-telefono') || '';
                
                const direccionCompleta = construirDireccionCompleta(direccion, codigoPostal, poblacion);
                direccionInput.value = direccionCompleta;
                telefonoInput.value = telefono;
            } else {
                // Si no hay selecci√≥n, limpiar campos
                direccionInput.value = '';
                telefonoInput.value = '';
            }
        }

        // Inicializar campos al cargar
        actualizarCampos();

        // Actualizar cuando cambia el tipo
        tipoVisitaSelect.addEventListener('change', actualizarCampos);

        // Event listeners para rellenar autom√°ticamente cuando se selecciona un cliente o centro de salud
        clienteSelect.addEventListener('change', function() {
            if (tipoVisitaSelect.value === 'Farmacia') {
                rellenarDatosCliente();
            }
        });

        centroSaludSelect.addEventListener('change', function() {
            if (tipoVisitaSelect.value === 'Sanitarios') {
                rellenarDatosCentroSalud();
            }
        });

        // Si hay un cliente o centro de salud preseleccionado, rellenar los datos al cargar
        if (tipoVisitaSelect.value === 'Farmacia' && clienteSelect.value) {
            rellenarDatosCliente();
        } else if (tipoVisitaSelect.value === 'Sanitarios' && centroSaludSelect.value) {
            rellenarDatosCentroSalud();
        }

        // Funci√≥n para generar enlace de Google Meet
        if (btnGenerarMeet) {
            btnGenerarMeet.addEventListener('click', async function() {
                btnGenerarMeet.disabled = true;
                btnGenerarMeet.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generando...';
                
                try {
                    // Generar enlace de Google Meet usando la API
                    const response = await fetch('/api/visitas/generar-meet', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            fecha: document.querySelector('input[name="fecha"]').value,
                            hora: document.querySelector('input[name="hora"]').value || '09:00',
                            titulo: tipoDetalleInput.value || 'Reuni√≥n'
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success && data.meetUrl) {
                        enlaceReunionInput.value = data.meetUrl;
                        btnGenerarMeet.innerHTML = '<i class="fas fa-check me-1"></i>Generado';
                        btnGenerarMeet.classList.remove('btn-outline-primary');
                        btnGenerarMeet.classList.add('btn-success');
                        setTimeout(() => {
                            btnGenerarMeet.innerHTML = '<i class="fab fa-google me-1"></i>Generar Meet';
                            btnGenerarMeet.classList.remove('btn-success');
                            btnGenerarMeet.classList.add('btn-outline-primary');
                        }, 2000);
                    } else {
                        // Si falla la API, generar enlace b√°sico de Meet
                        enlaceReunionInput.value = data.meetUrl || 'https://meet.google.com/new';
                        enlaceReunionInput.focus();
                        alert('Enlace generado. Puedes crear la reuni√≥n y copiar la URL permanente aqu√≠.');
                    }
                } catch (error) {
                    console.error('Error generando Meet:', error);
                    // En caso de error, generar enlace b√°sico de Meet
                    enlaceReunionInput.value = 'https://meet.google.com/new';
                    enlaceReunionInput.focus();
                    alert('Se ha generado un enlace b√°sico. Ve a meet.google.com para crear la reuni√≥n y luego copia la URL aqu√≠.');
                } finally {
                    btnGenerarMeet.disabled = false;
                }
            });
        }

        // Funci√≥n para probar el enlace
        if (btnProbarEnlace) {
            btnProbarEnlace.addEventListener('click', function() {
                const url = enlaceReunionInput.value.trim();
                if (url) {
                    window.open(url, '_blank');
                } else {
                    alert('Por favor, ingresa un enlace primero');
                }
            });
        }

        // Validaci√≥n del formulario
        document.getElementById('visitaForm').addEventListener('submit', function(e) {
            const tipo = tipoVisitaSelect.value;
            let valido = true;

            if (tipo === 'Farmacia' && !clienteSelect.value) {
                alert('Por favor, selecciona una farmacia');
                valido = false;
            } else if (tipo === 'Sanitarios' && !centroSaludSelect.value) {
                alert('Por favor, selecciona un centro de salud');
                valido = false;
            } else if ((tipo === 'Reuni√≥n' || tipo === 'Notas') && !tipoDetalleInput.value.trim()) {
                alert('Por favor, describe el tipo de visita');
                valido = false;
            }

            if (!valido) {
                e.preventDefault();
            }
        });
    </script>
    <script src="/js/go-to-top.js"></script>

    <!-- Go to Top Button -->
    <button id="goToTop" class="go-to-top" title="Ir arriba">
        <i class="fas fa-arrow-up"></i>
    </button>
</body>
</html>
